<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JP Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #12182b;
      --bg-card: #1a2238;
      --bg-input: #0f1524;
      --border-primary: #2a3654;
      --border-accent: #3d5a80;
      --text-primary: #e8ecf3;
      --text-secondary: #98a7c0;
      --text-muted: #6b7a94;
      --accent-gold: #f4c430;
      --accent-gold-hover: #ffd700;
      --accent-blue: #4a90e2;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 12px 0 rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 10px 30px 0 rgba(0, 0, 0, 0.6);
    

    .progress-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin:1rem 0;padding:1rem;background:var(--bg-input);border-radius:8px;border:1px solid var(--border-primary)}
    .progress-stat{text-align:center}
    .progress-stat-label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.5rem}
    .progress-stat-value{font-size:1.1rem;font-weight:600;color:var(--accent-blue)}
    .progress-controls{display:flex;gap:1rem;justify-content:center;margin-top:1rem}
    .spinner{width:20px;height:20px;border:3px solid rgba(244,196,48,0.3);border-top-color:var(--accent-gold);border-radius:50%;animation:spinner-rotate 0.8s linear infinite}
    @keyframes spinner-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    body.light-mode{--bg-primary:#f0f4f8;--bg-secondary:#fff;--bg-card:#fff;--bg-input:#f7fafc;--border-primary:#cbd5e0;--text-primary:#1a202c;--text-secondary:#2d3748;--text-muted:#4a5568;--accent-gold:#b7791f;--accent-blue:#2b6cb0;--accent-green:#2f855a;--accent-red:#c53030}
    body.light-mode{background:linear-gradient(135deg,#e8f0f7 0%,#f5f8fb 50%,#e8f0f7 100%)}
    body.light-mode header{background:rgba(255,255,255,0.95);border-bottom:1px solid #cbd5e0}
    body.light-mode .card,.light-mode .scenario-card{background:#fff!important;box-shadow:0 2px 12px rgba(0,0,0,0.1)!important;border:1px solid #e2e8f0!important}
    body.light-mode .jp-mini-section{background:#f7fafc!important;border:1.5px solid #cbd5e0!important}
    body.light-mode h1,body.light-mode h2,body.light-mode h3,body.light-mode h4{color:#2d3748!important}
    body.light-mode input,body.light-mode select{background:#fff!important;color:#1a202c!important;border:1.5px solid #cbd5e0!important}
    body.light-mode button.primary{background:linear-gradient(135deg,#b7791f 0%,#975a16 100%)!important}
    body.light-mode button.secondary{background:#edf2f7!important;color:#2d3748!important}
    body.light-mode table{background:#fff!important;border:1px solid #e2e8f0!important}
    body.light-mode th{color:#2d3748!important}
    body.light-mode td{color:#1a202c!important}
    body{transition:background 0.3s ease}

}
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1221 50%, var(--bg-primary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    
    header {
      background: rgba(18, 24, 43, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-primary);
      padding: 1.75rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-md);
    }
    
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--accent-gold);
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2.5rem 2rem;
    }
    
    .flex-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
    
    .card {
      background: linear-gradient(135deg, rgba(26, 34, 56, 0.95) 0%, rgba(18, 24, 43, 0.95) 100%);
      border-radius: 16px;
      border: 1px solid var(--border-primary);
      padding: 2rem;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 2.5rem;
    }
    
    .card:hover {
      border-color: var(--border-accent);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .flex-row .card {
      margin-bottom: 0;
    }
    
    .card h2 {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-primary);
    }
    
    .card h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-gold);
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      font-size: 0.813rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.01em;
    }
    
    input, select {
      width: 100%;
      padding: 0.625rem 0.875rem;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
      margin-bottom: 0.75rem;
      transition: all 0.2s ease;
      outline: none;
    }
    
    input:hover {
      border-color: var(--border-accent);
    }
    
    input:focus, select:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    
    input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
      accent-color: var(--accent-gold);
    }
    
    .jp-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    
    .jp-tag {
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.688rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .platinum { 
      background: linear-gradient(135deg, #5b6b8f 0%, #3f4d6b 100%);
      color: #e8ecf3;
      box-shadow: 0 2px 6px rgba(91, 107, 143, 0.3);
    }
    
    .gold { 
      background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
      color: #1a1a1a;
      box-shadow: 0 2px 6px rgba(212, 175, 55, 0.4);
    }
    
    .diamond { 
      background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(79, 195, 247, 0.4);
    }
    
    button {
      background: linear-gradient(135deg, var(--accent-gold) 0%, #e6b422 100%);
      border: none;
      color: #1a1a1a;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.875rem;
      letter-spacing: 0.01em;
      cursor: pointer;
      margin-top: 0.75rem;
      margin-right: 0.75rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(244, 196, 48, 0.3);
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(244, 196, 48, 0.5);
      background: linear-gradient(135deg, var(--accent-gold-hover) 0%, var(--accent-gold) 100%);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button.secondary {
      background: linear-gradient(135deg, #3d5a80 0%, #2a3f5f 100%);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(61, 90, 128, 0.3);
    }
    
    button.secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #4a6a94 0%, #3d5a80 100%);
      box-shadow: 0 4px 16px rgba(61, 90, 128, 0.5);
    }
    
    button.small {
      padding: 0.5rem 1rem;
      font-size: 0.813rem;
    }
    
    button.green {
      background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    button.green:hover:not(:disabled) {
      background: linear-gradient(135deg, #34d399 0%, var(--accent-green) 100%);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.5);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 1rem;
      font-size: 0.813rem;
      overflow: hidden;
      border-radius: 8px;
    }
    
    th, td {
      padding: 0.75rem 1rem;
      text-align: right;
      border-bottom: 1px solid var(--border-primary);
    }
    
    th {
      background: linear-gradient(135deg, rgba(61, 90, 128, 0.3) 0%, rgba(42, 63, 95, 0.3) 100%);
      text-align: center;
      color: var(--accent-gold);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    td:first-child {
      text-align: left;
      font-weight: 500;
    }
    
    tbody tr {
      transition: background-color 0.2s ease;
    }
    
    tbody tr:hover {
      background: rgba(61, 90, 128, 0.1);
    }
    
    tbody tr:last-child td {
      border-bottom: none;
    }
    
    .small-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-top: 0.75rem;
      font-weight: 400;
    }
    
    .inline {
      display: inline-block;
      width: calc(50% - 1rem);
      margin-right: 2rem;
    }
    
    .inline:nth-child(2n) {
      margin-right: 0;
    }
    
    @media (max-width: 900px) {
      .inline {
        width: 100%;
        margin-right: 0;
        margin-bottom: 1rem;
      }
    }
    
    canvas {
      background: var(--bg-input);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      width: 100%;
      height: auto;
      box-shadow: var(--shadow-sm);
    }
    
    .result-highlight {
      color: var(--accent-gold);
      font-weight: 600;
    }
    
    .info-box {
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(74, 144, 226, 0.05) 100%);
      border-left: 3px solid var(--accent-blue);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 1rem 0 1.5rem 0;
      font-size: 0.813rem;
      color: var(--text-secondary);
    }
    
    .success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
      border-left: 3px solid var(--accent-green);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 1rem 0 1.5rem 0;
      font-size: 0.813rem;
      color: #86efac;
    }
    
    .error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
      border-left: 3px solid var(--accent-red);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 1rem 0 1.5rem 0;
      font-size: 0.813rem;
      color: #fca5a5;
    }
    
    .warning {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
      border-left: 3px solid #fbbf24;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 1rem 0 1.5rem 0;
      font-size: 0.813rem;
      color: #fde68a;
    }
    
    .info-label {
      color: var(--accent-gold);
      font-weight: 600;
      margin-right: 0.5rem;
    }
    
    #validationWarnings {
      margin-bottom: 2.5rem;
    }
    
    .monte-carlo-results {
      display: none;
      margin-top: 1.5rem;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      margin-top: 1rem;
    }
    
    .stat-item {
      background: linear-gradient(135deg, rgba(15, 21, 36, 0.6) 0%, rgba(12, 17, 30, 0.6) 100%);
      padding: 1.25rem;
      border-radius: 10px;
      border: 1px solid var(--border-primary);
      border-left: 3px solid var(--accent-gold);
      transition: all 0.2s ease;
    }
    
    .stat-item:hover {
      border-color: var(--accent-gold);
      background: linear-gradient(135deg, rgba(15, 21, 36, 0.8) 0%, rgba(12, 17, 30, 0.8) 100%);
    }
    
    .stat-item label {
      margin: 0 0 0.5rem 0;
      font-size: 0.688rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }
    
    .stat-item .value {
      font-size: 1.5rem;
      color: var(--accent-gold);
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    
    .scenario-section {
      display: none;
      margin-top: 3rem;
    }
    
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 1.5rem;
    }
    
    .scenario-card {
      background: linear-gradient(135deg, rgba(15, 21, 36, 0.6) 0%, rgba(12, 17, 30, 0.6) 100%);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-primary);
      transition: all 0.3s ease;
    }
    
    .scenario-card:hover {
      border-color: var(--border-accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .scenario-card.active {
      border-color: var(--accent-gold);
      box-shadow: 0 0 20px rgba(244, 196, 48, 0.2);
    }
    
    .scenario-input,
    .scenario-input-small {
      width: 100%;
      padding: 0.5rem 0.75rem;
      margin-top: 0.375rem;
      border-radius: 6px;
      border: 1px solid var(--border-primary);
      background: rgba(10, 14, 26, 0.8);
      color: var(--text-primary);
      font-size: 0.813rem;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    
    .scenario-input-small {
      padding: 0.375rem 0.625rem;
      font-size: 0.75rem;
    }
    
    .comparison-highlight {
      background: rgba(74, 144, 226, 0.15);
      font-weight: 600;
    }
    
    .auto-generator {
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.08) 0%, rgba(74, 144, 226, 0.04) 100%);
      padding: 1.75rem;
      border-radius: 12px;
      margin-bottom: 2.5rem;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }
    
    .auto-generator h3 {
      margin-top: 0;
      color: var(--accent-blue);
      font-size: 1rem;
    }
    
    .contrib-preview {
      background: rgba(10, 14, 26, 0.6);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.6;
      border: 1px solid var(--border-primary);
    }
    
    .jp-mini-section {
      background: rgba(10, 14, 26, 0.6);
      padding: 0.875rem;
      border-radius: 8px;
      margin-top: 0.75rem;
      border: 1px solid var(--border-primary);
    }
    
    .jp-mini-section h4 {
      margin: 0 0 0.625rem 0;
      font-size: 0.813rem;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      margin: 1rem 0;
      font-size: 0.813rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .warning-box {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
      border-left: 3px solid #fbbf24;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 1rem 0 1.5rem 0;
      font-size: 0.813rem;
      color: #fde68a;
    }
    
    .currency-section {
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(74, 144, 226, 0.02) 100%);
      padding: 1.5rem;
      border-radius: 12px;
      margin-top: 2.5rem;
      border: 1px solid rgba(74, 144, 226, 0.2);
    }
    
    .currency-section h4 {
      margin: 0 0 1.25rem 0;
      color: var(--accent-blue);
      font-size: 0.938rem;
      font-weight: 600;
    }
    
    .progress-container {
      display: none;
      margin-top: 1.5rem;
      background: linear-gradient(135deg, rgba(15, 21, 36, 0.8) 0%, rgba(12, 17, 30, 0.8) 100%);
      border-radius: 12px;
      padding: 1.75rem;
      border: 1px solid var(--border-accent);
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .progress-header h3 {
      margin: 0;
      color: var(--accent-blue);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .progress-percentage {
      color: var(--accent-gold);
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: -0.02em;
    }
    
    .progress-bar-wrapper {
      width: 100%;
      height: 32px;
      background: rgba(10, 14, 26, 0.8);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border-primary);
      position: relative;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 1rem;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.75rem;
      box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
    }
    
    .progress-bar.pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
      }
      50% {
        box-shadow: 0 0 30px rgba(74, 144, 226, 0.9);
      }
    }
    
    .progress-info {
      margin-top: 0.875rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }
    
    .custom-currency-box {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.04) 100%);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .custom-currency-box h4 {
      margin: 0 0 1rem 0;
      color: var(--accent-green);
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .custom-currency-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1.25rem;
      align-items: end;
    }
    
    .custom-currency-item {
      display: flex;
      flex-direction: column;
    }
    
    .custom-currency-item label {
      margin: 0 0 0.375rem 0;
      font-size: 0.75rem;
    }
    
    .custom-currency-item input {
      margin-bottom: 0;
    }
    
    .crypto-prefix-box {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(251, 191, 36, 0.04) 100%);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(251, 191, 36, 0.3);
      display: none;
    }
    
    .crypto-prefix-box h4 {
      margin: 0 0 0.875rem 0;
      color: #fbbf24;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .prefix-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.25rem;
      align-items: end;
    }
    
    .crypto-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1a1a1a;
      padding: 0.25rem 0.625rem;
      border-radius: 6px;
      font-size: 0.625rem;
      font-weight: 700;
      margin-left: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .rate-display-box {
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.08) 0%, rgba(74, 144, 226, 0.04) 100%);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 0.875rem;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }
    
    .rate-display-box input {
      background: rgba(10, 14, 26, 0.6);
      color: var(--accent-blue);
      font-weight: 600;
      border: 1px solid rgba(74, 144, 226, 0.4);
      text-align: center;
      font-size: 0.813rem;
    }
    
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-accent);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue);
    }

.tip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 15px;
  height: 15px;
  background: rgba(74, 144, 226, 0.25);
  color: var(--accent-blue);
  border-radius: 50%;
  font-size: 0.65rem;
  font-weight: 700;
  cursor: help;
  position: relative;
  margin-left: 5px;
  vertical-align: middle;
  border: 1px solid rgba(74, 144, 226, 0.4);
  flex-shrink: 0;
}
.tip::after {
  content: attr(data-tip);
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: #1a2238;
  color: #e8ecf3;
  border: 1px solid var(--border-accent);
  border-radius: 8px;
  padding: 0.6rem 0.85rem;
  font-size: 0.75rem;
  font-weight: 400;
  line-height: 1.5;
  white-space: normal;
  width: 260px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 9999;
}
.tip:hover::after {
  opacity: 1;
}
body.light-mode .tip::after {
  background: #fff;
  color: #1a202c;
  border-color: #cbd5e0;
}

/* ===== TOOLTIP SYSTEM ===== */
.tip {
  display: inline-flex; align-items: center; justify-content: center;
  width: 15px; height: 15px;
  background: rgba(74,144,226,0.25); color: var(--accent-blue);
  border-radius: 50%; font-size: 0.65rem; font-weight: 700;
  cursor: help; position: relative; margin-left: 5px;
  vertical-align: middle; border: 1px solid rgba(74,144,226,0.4); flex-shrink: 0;
}
.tip::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 8px); left: 50%;
  transform: translateX(-50%);
  background: #1a2238; color: #e8ecf3;
  border: 1px solid var(--border-accent); border-radius: 8px;
  padding: 0.6rem 0.85rem; font-size: 0.75rem; font-weight: 400;
  line-height: 1.5; white-space: normal; width: 260px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 9999;
}
.tip:hover::after { opacity: 1; }
body.light-mode .tip::after { background: #fff; color: #1a202c; border-color: #cbd5e0; }




  
/* ===== SCENARIO NOVI LAYOUT ===== */
.sc-contrib-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px}
.sc-contrib-item label{font-size:11px;color:var(--text-muted);margin-bottom:2px;display:block}
.sc-contrib-item input{margin-bottom:0!important}
.scenario-live{background:rgba(10,14,26,0.85);border:1px solid var(--border-accent);border-radius:8px;padding:10px 13px;margin:12px 0 10px 0;font-size:0.79rem}
.scenario-live .sl-title{font-size:0.71rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--accent-blue);margin-bottom:5px}
.scenario-live .sl-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid rgba(42,54,84,0.35)}
.scenario-live .sl-row:last-child{border-bottom:none}
.scenario-live .sl-lbl{color:var(--text-muted)}
.scenario-live .sl-val{font-weight:600;color:var(--text-primary)}
.scenario-live .sl-rtp{font-weight:700;color:var(--accent-gold);font-size:.87rem}
.ct-sep-pl td{border-top:2px solid rgba(232,236,243,0.25)!important;padding-top:8px!important}
.ct-sep-gd td{border-top:2px solid rgba(251,191,36,0.35)!important;padding-top:8px!important}
.ct-sep-dm td{border-top:2px solid rgba(79,195,247,0.35)!important;padding-top:8px!important}
.ct-label-pl td:first-child{color:#e8ecf3!important;font-weight:700!important}
.ct-label-gd td:first-child{color:var(--accent-gold)!important;font-weight:700!important}
.ct-label-dm td:first-child{color:#4fc3f7!important;font-weight:700!important}


    .sc-total-contrib {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(244, 196, 48, 0.08);
      border: 1px solid rgba(244, 196, 48, 0.25);
      border-radius: 6px;
      padding: 0.3rem 0.65rem;
      margin: 0.35rem 0 0.25rem 0;
      font-size: 0.78rem;
    }
    .sc-total-label { color: var(--text-secondary); }
    .sc-total-value { color: var(--accent-gold); font-weight: 700; }
    .sc-warnings .error {
      background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%);
      border-left: 3px solid #ef4444;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      margin: 0.4rem 0;
      font-size: 0.72rem;
      color: #fca5a5;
      line-height: 1.5;
    }
    .sc-warnings .warning {
      background: linear-gradient(135deg, rgba(251,191,36,0.1) 0%, rgba(251,191,36,0.05) 100%);
      border-left: 3px solid #fbbf24;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      margin: 0.4rem 0;
      font-size: 0.72rem;
      color: #fde68a;
      line-height: 1.5;
    }
  
    .sc-contrib-summary {
      background: rgba(74, 144, 226, 0.06);
      border: 1px solid rgba(74, 144, 226, 0.2);
      border-radius: 8px;
      padding: 0.6rem 0.75rem;
      margin: 0.5rem 0 0.4rem 0;
      font-size: 0.75rem;
    }
    .sc-contrib-summary .scs-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 0.45rem;
    }
    .sc-contrib-summary .scs-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.18rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      gap: 0.5rem;
    }
    .sc-contrib-summary .scs-row:last-child { border-bottom: none; }
    .sc-contrib-summary .scs-name { color: var(--text-secondary); min-width: 75px; }
    .sc-contrib-summary .scs-vals { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
    .sc-contrib-summary .scs-std  { color: var(--accent-blue); }
    .sc-contrib-summary .scs-hid  { color: #a78bfa; }
    .sc-contrib-summary .scs-tot  { color: var(--accent-gold); font-weight: 700; }
    button.small.secondary:disabled,
    button.small.secondary[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
      pointer-events: none;
    }
  
    /* ===== LIGHT MODE - nove klase (V9+) ===== */
    body.light-mode .scenario-live {
      background: #f0f4f8 !important;
      border: 1px solid #cbd5e0 !important;
    }
    body.light-mode .sl-title { color: #2b6cb0 !important; }
    body.light-mode .sl-row   { border-bottom-color: #e2e8f0 !important; }
    body.light-mode .sl-lbl   { color: #4a5568 !important; }
    body.light-mode .sl-val   { color: #1a202c !important; }
    body.light-mode .sl-rtp   { color: #b7791f !important; }
    body.light-mode .sc-contrib-summary {
      background: rgba(43,108,176,0.06) !important;
      border: 1px solid rgba(43,108,176,0.2) !important;
    }
    body.light-mode .scs-title { color: #4a5568 !important; }
    body.light-mode .scs-row   { border-bottom-color: #e2e8f0 !important; }
    body.light-mode .scs-name  { color: #2d3748 !important; }
    body.light-mode .scs-std   { color: #2b6cb0 !important; }
    body.light-mode .scs-hid   { color: #6b46c1 !important; }
    body.light-mode .scs-tot   { color: #b7791f !important; }
    body.light-mode .sc-warnings .error {
      background: linear-gradient(135deg,rgba(197,48,48,0.08) 0%,rgba(197,48,48,0.04) 100%) !important;
      border-left-color: #c53030 !important; color: #9b2c2c !important;
    }
    body.light-mode .sc-warnings .warning {
      background: linear-gradient(135deg,rgba(183,121,31,0.1) 0%,rgba(183,121,31,0.05) 100%) !important;
      border-left-color: #b7791f !important; color: #7b341e !important;
    }
    body.light-mode button.small.secondary:disabled,
    body.light-mode button.small.secondary[disabled] {
      opacity: 0.4 !important; background: #e2e8f0 !important; color: #a0aec0 !important;
    }
    body.light-mode .sc-total-label { color: #4a5568 !important; }
    body.light-mode .sc-total-value { color: #b7791f !important; }

    /* ===== RESPONSIVE / MOBILE ===== */
    @media (max-width: 768px) {
      header > div { flex-wrap: wrap; gap: 0.75rem; padding: 0.5rem 1rem; }
      header h1 { font-size: 1.3rem !important; }
      .container { padding: 1.25rem 1rem !important; }
      .flex-row { grid-template-columns: 1fr !important; }
      .scenario-grid { grid-template-columns: 1fr !important; }
      .stat-grid { grid-template-columns: repeat(2,1fr) !important; }
      .progress-stats-grid { grid-template-columns: repeat(2,1fr) !important; }
      .scs-vals { flex-wrap: wrap; gap: 0.3rem; }
      table { font-size: 0.75rem !important; display: block; overflow-x: auto;
              white-space: nowrap; -webkit-overflow-scrolling: touch; }
      .progress-controls { flex-wrap: wrap; gap: 0.5rem; }
      canvas { width: 100% !important; }
    }
    @media (max-width: 480px) {
      header h1 { font-size: 1.1rem !important; }
      h2 { font-size: 1.1rem !important; }
      h3 { font-size: 0.95rem !important; }
      .card { padding: 1rem !important; border-radius: 10px !important; }
      .scenario-card { padding: 1rem !important; }
      .jp-mini-section { padding: 0.75rem !important; }
      .stat-grid { grid-template-columns: 1fr !important; }
      input[type="number"], input[type="text"], select {
        font-size: 0.95rem !important; padding: 0.5rem 0.75rem !important; }
      #runSimBtn, #runMonteCarloBtn { width: 100%; display: block;
        margin-left: 0 !important; margin-bottom: 0.5rem !important; }
      #exportExcelBtn { width: 100%; display: block; margin-left: 0 !important; }
      .jp-header { flex-wrap: wrap; gap: 0.4rem; }
      .scs-row { flex-direction: column; align-items: flex-start; gap: 0.2rem; }
      .sl-row { flex-direction: column; align-items: flex-start; padding: 0.3rem 0; }
      .scenario-live { font-size: 0.78rem !important; }
      table { font-size: 0.68rem !important; display: block; overflow-x: auto;
              white-space: nowrap; -webkit-overflow-scrolling: touch; }
      .tip { display: none; }
      .info-box { font-size: 0.75rem !important; padding: 0.75rem !important; }
      .sc-contrib-summary { font-size: 0.72rem !important; }
      .chart-controls { flex-direction: column; gap: 0.4rem; }
    }

  
    /* Placeholder styling */
    input::placeholder {
      color: var(--text-muted);
      opacity: 0.55;
      font-style: italic;
      font-size: 0.82em;
    }
    body.light-mode input::placeholder {
      color: #94a3b8;
      opacity: 0.8;
    }

  </style>
  <!-- SheetJS Library za Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1600px; margin: 0 auto;">
      <h1 style="margin: 0; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; color: var(--accent-gold);">üé∞ Jackpot Simulator</h1>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <div style="text-align: right;">
          <div style="font-size: 0.7rem; color: var(--text-muted);" id="ratesTimestamp">Rates loading...</div>
          <button id="refreshRatesBtn" class="secondary" style="padding: 0.5rem 0.9rem; font-size: 0.85rem;">
            üîÑ <span id="refreshText">Refresh</span>
          </button>
        </div>
        <button id="themeToggle" class="secondary" style="padding: 0.65rem 1.2rem; font-size: 0.95rem; cursor: pointer;">
          <span id="themeIcon">‚òÄÔ∏è</span> <span id="themeText">Light Mode</span>
        </button>
      </div>
    </div>
  </header>

<div class="container">
  <div class="card">
    <h2>Globalni parametri</h2>
    <div class="flex-row">
      <div class="inline">
        <label for="winBetRatioPercent">Win/Bet Ratio (bez JP) [%] <span class="tip" data-tip="Procenat turnover-a koji se vraƒáa igraƒçima iz base game-a (bez JP). Tipiƒçno 94-97%. Npr. 96.5% znaƒçi da od 100 EUR opklada, 96.50 EUR ide igraƒçima.">‚ìò</span></label>

        <input type="number" id="winBetRatioPercent" value="96.5" step="0.1">
      </div>
      <div class="inline">
        <label for="monthlyTurnoverEur">Meseƒçni total BET EUR <span class="tip" data-tip="Ukupan iznos svih opklada u mesecu u EUR. Osnova za sve RTP i GGR kalkulacije. Veƒái promet = stabilniji rezultati simulacije.">‚ìò</span></label>

        <input type="text" id="monthlyTurnoverEur" value="" placeholder="npr. 11,000,000">
      </div>
    </div>
    <div class="flex-row">
      <div class="inline">
        <label for="granularity">Simulation Granularity (EUR po iteraciji) <span class="tip" data-tip="Veliƒçina jedne iteracije u EUR. Vrednost 1 = jedna iteracija po EUR prometa. Manji broj = preciznija simulacija ali sporija. Preporuƒçeno: 1 EUR.">‚ìò</span></label>

        <input type="number" id="granularity" value="1" step="0.1" min="0.1">
      </div>
      <div class="inline">
        <label for="seed">Random seed (opciono) <span class="tip" data-tip="Fiksirani seed osigurava identiƒçne rezultate pri svakom pokretanju. Korisno za reprodukciju specifiƒçnih scenarija. Prazno = novi random seed svaki put.">‚ìò</span></label>

        <input type="number" id="seed" placeholder="12345">
      </div>
    </div>
    <div class="info-box" id="iterationInfo">
      <span class="info-label">Broj iteracija:</span>
      <span id="iterationCount">-</span> 
    </div>
  </div>

  <div class="flex-row">
    <div class="card">
      <div class="jp-header">
        <h2>Platinum JP</h2>
        <span class="jp-tag platinum">Platinum</span>
      </div>
      <label>Base Value (EUR) <span class="tip" data-tip="Vrednost JP-a odmah nakon dropa ‚Äî to je minimum od kojeg JP poƒçinje ponovo da raste. JP nikad ne mo≈æe biti ispod ove vrednosti.">‚ìò</span></label>

      <input type="number" id="pl_base" value="" placeholder="npr. 10" step="0.01">
      <label>Min Drop Zone (EUR) <span class="tip" data-tip="Najni≈æi moguƒái iznos na koji JP mo≈æe da padne. Hit point se bira nasumiƒçno izmeƒëu Min i Max. GAP = Min - Base: veƒái GAP znaƒçi da JP mora vi≈°e da naraste pre pada.">‚ìò</span></label>

      <input type="number" id="pl_min" value="" placeholder="npr. 15" step="0.01">
      <label>Max Drop Zone (EUR) <span class="tip" data-tip="Najvi≈°i moguƒái iznos na koji JP mo≈æe da padne. Ako JP dostigne Max, pad je zagarantovan. Raspon Min-Max odreƒëuje proseƒçan iznos isplate.">‚ìò</span></label>

      <input type="number" id="pl_max" value="" placeholder="npr. 35" step="0.01">
      <div class="warning-box" id="pl_gap_warning" style="display:none;">
        ‚ö†Ô∏è <strong>GAP = 0 EUR</strong> ‚Üí JP pada ODMAH! Za reƒëe dropove, poveƒáaj Min.
      </div>
      <label>Bet Requirement (EUR - samo za info) <span class="tip" data-tip="Minimalni iznos opklade da bi igraƒç bio kvalifikovan za ovaj JP nivo. Samo informativno ‚Äî ne utiƒçe na simulaciju.">‚ìò</span></label>

      <input type="number" id="pl_bet_req" value="" placeholder="npr. 0.05" step="0.01">
      <label>Standard Contribution [%] <span class="tip" data-tip="Vidljivi procenat svake opklade koji puni JP fond. Direktno odreƒëuje brzinu rasta JP-a i JP RTP doprinos. Npr. 0.27% znaƒçi 0.0027 EUR po svakom 1 EUR opklade.">‚ìò</span></label>

      <input type="number" id="pl_std" value="" placeholder="npr. 0.27" step="0.001">
      <label>Hidden Contribution [%] <span class="tip" data-tip="Skrivena kontribucija koja se akumulira u JP ali se ne prikazuje igraƒçu. Resetuje se na 0 nakon svakog dropa. Poveƒáava proseƒçan iznos isplate bez poveƒáanja vidljive vrednosti JP-a.">‚ìò</span></label>

      <input type="number" id="pl_hidden" value="" placeholder="npr. 0.03" step="0.001">
    </div>

    <div class="card">
      <div class="jp-header">
        <h2>Gold JP</h2>
        <span class="jp-tag gold">Gold</span>
      </div>
      <label>Base Value (EUR) <span class="tip" data-tip="Vrednost JP-a odmah nakon dropa ‚Äî to je minimum od kojeg JP poƒçinje ponovo da raste. JP nikad ne mo≈æe biti ispod ove vrednosti.">‚ìò</span></label>

      <input type="number" id="gd_base" value="" placeholder="npr. 15" step="0.01">
      <label>Min Drop Zone (EUR) <span class="tip" data-tip="Najni≈æi moguƒái iznos na koji JP mo≈æe da padne. Hit point se bira nasumiƒçno izmeƒëu Min i Max. GAP = Min - Base: veƒái GAP znaƒçi da JP mora vi≈°e da naraste pre pada.">‚ìò</span></label>

      <input type="number" id="gd_min" value="" placeholder="npr. 40" step="0.01">
      <label>Max Drop Zone (EUR) <span class="tip" data-tip="Najvi≈°i moguƒái iznos na koji JP mo≈æe da padne. Ako JP dostigne Max, pad je zagarantovan. Raspon Min-Max odreƒëuje proseƒçan iznos isplate.">‚ìò</span></label>

      <input type="number" id="gd_max" value="" placeholder="npr. 110" step="0.01">
      <div class="info-box" id="gd_gap_info">
        üìä <strong>GAP:</strong> <span id="gd_gap_value">25.5 EUR</span>
      </div>
      <label>Bet Requirement (EUR - samo za info) <span class="tip" data-tip="Minimalni iznos opklade da bi igraƒç bio kvalifikovan za ovaj JP nivo. Samo informativno ‚Äî ne utiƒçe na simulaciju.">‚ìò</span></label>

      <input type="number" id="gd_bet_req" value="" placeholder="npr. 0.40" step="0.01">
      <label>Standard Contribution [%] <span class="tip" data-tip="Vidljivi procenat svake opklade koji puni JP fond. Direktno odreƒëuje brzinu rasta JP-a i JP RTP doprinos. Npr. 0.27% znaƒçi 0.0027 EUR po svakom 1 EUR opklade.">‚ìò</span></label>

      <input type="number" id="gd_std" value="" placeholder="npr. 0.13" step="0.001">
      <label>Hidden Contribution [%] <span class="tip" data-tip="Skrivena kontribucija koja se akumulira u JP ali se ne prikazuje igraƒçu. Resetuje se na 0 nakon svakog dropa. Poveƒáava proseƒçan iznos isplate bez poveƒáanja vidljive vrednosti JP-a.">‚ìò</span></label>

      <input type="number" id="gd_hidden" value="" placeholder="npr. 0.01" step="0.001">
    </div>

    <div class="card">
      <div class="jp-header">
        <h2>Diamond JP</h2>
        <span class="jp-tag diamond">Diamond</span>
      </div>
      <label>Base Value (EUR) <span class="tip" data-tip="Vrednost JP-a odmah nakon dropa ‚Äî to je minimum od kojeg JP poƒçinje ponovo da raste. JP nikad ne mo≈æe biti ispod ove vrednosti.">‚ìò</span></label>

      <input type="number" id="dm_base" value="" placeholder="npr. 350" step="0.01">
      <label>Min Drop Zone (EUR) <span class="tip" data-tip="Najni≈æi moguƒái iznos na koji JP mo≈æe da padne. Hit point se bira nasumiƒçno izmeƒëu Min i Max. GAP = Min - Base: veƒái GAP znaƒçi da JP mora vi≈°e da naraste pre pada.">‚ìò</span></label>

      <input type="number" id="dm_min" value="" placeholder="npr. 600" step="0.01">
      <label>Max Drop Zone (EUR) <span class="tip" data-tip="Najvi≈°i moguƒái iznos na koji JP mo≈æe da padne. Ako JP dostigne Max, pad je zagarantovan. Raspon Min-Max odreƒëuje proseƒçan iznos isplate.">‚ìò</span></label>

      <input type="number" id="dm_max" value="" placeholder="npr. 1000" step="0.01">
      <div class="info-box" id="dm_gap_info">
        üìä <strong>GAP:</strong> <span id="dm_gap_value">212.5 EUR</span>
      </div>
      <label>Bet Requirement (EUR - samo za info) <span class="tip" data-tip="Minimalni iznos opklade da bi igraƒç bio kvalifikovan za ovaj JP nivo. Samo informativno ‚Äî ne utiƒçe na simulaciju.">‚ìò</span></label>

      <input type="number" id="dm_bet_req" value="" placeholder="npr. 1.00" step="0.01">
      <label>Standard Contribution [%] <span class="tip" data-tip="Vidljivi procenat svake opklade koji puni JP fond. Direktno odreƒëuje brzinu rasta JP-a i JP RTP doprinos. Npr. 0.27% znaƒçi 0.0027 EUR po svakom 1 EUR opklade.">‚ìò</span></label>

      <input type="number" id="dm_std" value="" placeholder="npr. 0.13" step="0.001">
      <label>Hidden Contribution [%] <span class="tip" data-tip="Skrivena kontribucija koja se akumulira u JP ali se ne prikazuje igraƒçu. Resetuje se na 0 nakon svakog dropa. Poveƒáava proseƒçan iznos isplate bez poveƒáanja vidljive vrednosti JP-a.">‚ìò</span></label>

      <input type="number" id="dm_hidden" value="" placeholder="npr. 0.01" step="0.001">
    </div>
  </div>

  <div id="validationWarnings"></div>

  <div class="card">
    <h2>Pokreni simulaciju</h2>
    <button id="runSimBtn">‚ñ∂ Run Single Simulation</button>
<button id="exportExcelBtn" class="secondary" style="margin-left: 10px;" disabled>üìä Export to Excel</button>

    <button id="runMonteCarloBtn" class="secondary">üé≤ Run Monte Carlo (100 runs)</button>
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="spinner" id="progressSpinner"></div>
          <h3>‚è≥ Monte Carlo Simulation u toku...</h3>
        </div>
        <span class="progress-percentage" id="progressPercentage">0%</span>
      </div>
      <div class="progress-bar-wrapper">
        <div class="progress-bar pulse" id="progressBar"><span id="progressText"></span></div>
      </div>
      <div class="progress-stats-grid">
        <div class="progress-stat"><div class="progress-stat-label">Simulacije</div><div class="progress-stat-value"><strong id="currentRun">0</strong> / <strong id="totalRuns">100</strong></div></div>
        <div class="progress-stat"><div class="progress-stat-label">Brzina</div><div class="progress-stat-value" id="simulationSpeed">- sim/s</div></div>
        <div class="progress-stat"><div class="progress-stat-label">Preostalo vreme</div><div class="progress-stat-value" id="estimatedTime">Calculating...</div></div>
        <div class="progress-stat"><div class="progress-stat-label">Ukupno vreme</div><div class="progress-stat-value" id="elapsedTime">0s</div></div>
      </div>
      <div class="progress-controls">
        <button id="pauseResumeBtn" class="secondary small" style="display:none;"><span id="pauseIcon">‚è∏</span> <span id="pauseText">Pause</span></button>
        <button id="cancelSimBtn" class="secondary small" style="display:none; background: var(--accent-red);">‚èπ Cancel</button>
      </div>
    </div>

    <div class="monte-carlo-results" class="monte-carlo-results" id="monteCarloResults">
      <h2>üé≤ Monte Carlo Analysis (100 simulacija)</h2>
      <div class="stat-grid">
        <div class="stat-item">
          <label>Proseƒçan JP RTP</label>
          <div class="value" id="mcAvgRtp">-</div>
        </div>
        <div class="stat-item">
          <label>Minimum JP RTP</label>
          <div class="value" id="mcMinRtp">-</div>
        </div>
        <div class="stat-item">
          <label>Maximum JP RTP</label>
          <div class="value" id="mcMaxRtp">-</div>
        </div>
        <div class="stat-item">
          <label>Std Deviation</label>
          <div class="value" id="mcStdDev">-</div>
        </div>
        <div class="stat-item">
          <label>95% Confidence Int.</label>
          <div class="value" id="mcConfidence">-</div>
        </div>
        <div class="stat-item">
          <label>Volatilnost</label>
          <div class="value" id="mcVolatility">-</div>
        </div>
      </div>
      
      <h3 style="margin-top: 30px;">Proseƒçan broj dropova (100 simulacija)</h3>
      <table>
        <tr>
          <th>JP Nivo</th><th>Prosek</th><th>Min</th><th>Max</th><th>Std Dev</th>
        </tr>
        <tbody id="mcDropsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="flex-row">
    <div class="card">
      <h2>RTP / House Edge</h2>
      <table>
        <tr><th>Metrika</th><th>Vrednost</th></tr>
        <tr><td>Base game RTP (bez JP)</td><td id="baseRtpCell">-</td></tr>
        <tr><td>JP RTP doprinos</td><td id="jpRtpCell">-</td></tr>
        <tr><td>Ukupan RTP (base + JP)</td><td id="totalRtpCell" class="result-highlight">-</td></tr>
        <tr><td>House Edge (1 - RTP)</td><td id="houseEdgeCell" class="result-highlight">-</td></tr>
      </table>
    </div>

    <div class="card">
      <h2>üí∞ Ukupna Kontribucija (meseƒçno)</h2>
      <table>
        <tr><th>Tip</th><th>Iznos (EUR)</th><th>% od bet-a</th></tr>
        <tr>
          <td>Standard Kontribucija</td>
          <td id="totalStdCell">-</td>
          <td id="totalStdPctCell">-</td>
        </tr>
        <tr>
          <td>Hidden Kontribucija</td>
          <td id="totalHidCell">-</td>
          <td id="totalHidPctCell">-</td>
        </tr>
        <tr style="border-top: 2px solid var(--accent-gold);">
          <td><strong>UKUPNO</strong></td>
          <td id="totalContribCell" class="result-highlight">-</td>
          <td id="totalContribPctCell" class="result-highlight">-</td>
        </tr>
      </table>
    </div>
  </div>

  <div class="flex-row">
    <div class="card">
      <h2>üíµ GGR & Profitabilnost</h2>
      <table>
        <tr><th>Metrika</th><th>Vrednost</th></tr>
        <tr>
          <td>Total Paid Out (JP isplate)</td>
          <td id="totalPaidCell">-</td>
        </tr>
        <tr>
          <td>Base Game Profit (bez JP)</td>
          <td id="baseGameProfitCell">-</td>
        </tr>
        <tr style="border-top: 2px solid var(--accent-gold);">
          <td><strong>GGR (Gross Gaming Revenue)</strong></td>
          <td id="ggrCell" class="result-highlight">-</td>
        </tr>
        <tr>
          <td>GGR Margin (%)</td>
          <td id="ggrMarginCell" class="result-highlight">-</td>
        </tr>
      </table>
      <p class="small-note">GGR = Turnover - Base Game Wins - JP Payouts</p>
    </div>

    <div class="card">
      <h2>JP statistika (meseƒçni nivo)</h2>
      <table>
        <tr>
          <th>JP nivo</th><th># Dropova</th><th>Proseƒçan drop</th>
          <th>Ukupno isplaƒáeno</th>
        </tr>
        <tbody id="jpStatsBody">
          <tr><td colspan="4" style="text-align:center;">Nema podataka</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card scenario-section" id="scenarioSection">
    <h2>‚ö° Scenario Comparison Tool</h2>
    


  
    <h3 style="margin-top: 30px;">üîß Scenario Configuration & Fine-Tuning</h3>
    <div class="scenario-grid">
      <div class="scenario-card">
        <h3>üìã Conservative</h3>
        <label>Naziv:</label>
        <input type="text" class="scenario-input" id="scenarioA_name" value="Conservative">
        <div class="jp-mini-section"><h4>‚ö™ Platinum</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_pl_std" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_pl_hidden" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_pl_base" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 10" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_pl_min" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_pl_max" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 35" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üü° Gold</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_gd_std" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_gd_hidden" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_gd_base" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_gd_min" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 40" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_gd_max" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 110" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üíé Diamond</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_dm_std" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioA_dm_hidden" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_dm_base" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 350" step="1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_dm_min" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 600" step="1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioA_dm_max" oninput="updateAllScenarioContribs('A')" value="" placeholder="npr. 1000" step="1">
        </div>
        <div class="sc-contrib-summary" id="scContribSummary_A">
          <div class="scs-title">‚ö° Pregled kontribucija po nivou</div>
          <div class="scs-row">
            <span class="scs-name">‚ö™ Platinum</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_A_pl_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_A_pl_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_A_pl_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üü° Gold</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_A_gd_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_A_gd_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_A_gd_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üíé Diamond</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_A_dm_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_A_dm_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_A_dm_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row" style="border-top:1px solid rgba(183,121,31,0.4);margin-top:3px;padding-top:3px;">
            <span class="scs-name" style="font-weight:700;color:var(--accent-gold);">‚àë Ukupno</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_A_total_std" style="font-weight:600;">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_A_total_hid" style="font-weight:600;">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_A_total_tot" style="font-size:0.86rem;">‚Äî</span>
            </span>
          </div>
        </div>
        <div id="scWarnings_A" class="sc-warnings"></div>
        <div class="scenario-live" id="liveStatsA">
          <div class="sl-title">üìä Live procena (meseƒçno)</div>
          <div class="sl-row"><span class="sl-lbl">‚ö™ PL drops / avg payout:</span><span class="sl-val" id="lsA_pl">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üü° GD drops / avg payout:</span><span class="sl-val" id="lsA_gd">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üíé DM drops / avg payout:</span><span class="sl-val" id="lsA_dm">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl"><strong>Procenjeni JP RTP:</strong></span><span class="sl-rtp" id="lsA_rtp">‚Äî</span></div>
        </div>
        <button class="small secondary" id="runScenarioBtn_A" onclick="runScenario('A')">‚ñ∂ Run Scenario A</button>
      </div>
      
      <div class="scenario-card">
        <h3>üéØ Target</h3>
        <label>Naziv:</label>
        <input type="text" class="scenario-input" id="scenarioB_name" value="Target">
        <div class="jp-mini-section"><h4>‚ö™ Platinum</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_pl_std" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_pl_hidden" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_pl_base" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 10" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_pl_min" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_pl_max" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 35" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üü° Gold</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_gd_std" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_gd_hidden" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_gd_base" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_gd_min" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 40" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_gd_max" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 110" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üíé Diamond</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_dm_std" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioB_dm_hidden" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_dm_base" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 350" step="1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_dm_min" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 600" step="1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioB_dm_max" oninput="updateAllScenarioContribs('B')" value="" placeholder="npr. 1000" step="1">
        </div>
        <div class="sc-contrib-summary" id="scContribSummary_B">
          <div class="scs-title">‚ö° Pregled kontribucija po nivou</div>
          <div class="scs-row">
            <span class="scs-name">‚ö™ Platinum</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_B_pl_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_B_pl_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_B_pl_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üü° Gold</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_B_gd_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_B_gd_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_B_gd_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üíé Diamond</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_B_dm_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_B_dm_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_B_dm_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row" style="border-top:1px solid rgba(183,121,31,0.4);margin-top:3px;padding-top:3px;">
            <span class="scs-name" style="font-weight:700;color:var(--accent-gold);">‚àë Ukupno</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_B_total_std" style="font-weight:600;">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_B_total_hid" style="font-weight:600;">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_B_total_tot" style="font-size:0.86rem;">‚Äî</span>
            </span>
          </div>
        </div>
        <div id="scWarnings_B" class="sc-warnings"></div>
        <div class="scenario-live" id="liveStatsB">
          <div class="sl-title">üìä Live procena (meseƒçno)</div>
          <div class="sl-row"><span class="sl-lbl">‚ö™ PL drops / avg payout:</span><span class="sl-val" id="lsB_pl">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üü° GD drops / avg payout:</span><span class="sl-val" id="lsB_gd">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üíé DM drops / avg payout:</span><span class="sl-val" id="lsB_dm">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl"><strong>Procenjeni JP RTP:</strong></span><span class="sl-rtp" id="lsB_rtp">‚Äî</span></div>
        </div>
        <button class="small secondary" id="runScenarioBtn_B" onclick="runScenario('B')">‚ñ∂ Run Scenario B</button>
      </div>
      
      <div class="scenario-card">
        <h3>üöÄ Aggressive</h3>
        <label>Naziv:</label>
        <input type="text" class="scenario-input" id="scenarioC_name" value="Aggressive">
        <div class="jp-mini-section"><h4>‚ö™ Platinum</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_pl_std" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_pl_hidden" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_pl_base" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 10" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_pl_min" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_pl_max" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 35" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üü° Gold</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_gd_std" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_gd_hidden" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_gd_base" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 15" step="0.1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_gd_min" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 40" step="0.1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_gd_max" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 110" step="0.1">
        </div>
        <div class="jp-mini-section"><h4>üíé Diamond</h4>
          <div class="sc-contrib-row">
            <div class="sc-contrib-item"><label>Std (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_dm_std" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.12" step="0.01" min="0"></div>
            <div class="sc-contrib-item"><label>Hidden (%):</label>
              <input type="number" class="scenario-input-small" id="scenarioC_dm_hidden" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 0.01" step="0.01" min="0"></div>
          </div>
          <label style="font-size:11px;">Base (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_dm_base" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 350" step="1">
          <label style="font-size:11px;">Min (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_dm_min" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 600" step="1">
          <label style="font-size:11px;">Max (EUR):</label><input type="number" class="scenario-input-small" id="scenarioC_dm_max" oninput="updateAllScenarioContribs('C')" value="" placeholder="npr. 1000" step="1">
        </div>
        <div class="sc-contrib-summary" id="scContribSummary_C">
          <div class="scs-title">‚ö° Pregled kontribucija po nivou</div>
          <div class="scs-row">
            <span class="scs-name">‚ö™ Platinum</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_C_pl_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_C_pl_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_C_pl_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üü° Gold</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_C_gd_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_C_gd_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_C_gd_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row">
            <span class="scs-name">üíé Diamond</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_C_dm_std">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_C_dm_hid">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_C_dm_tot">‚Äî</span>
            </span>
          </div>
          <div class="scs-row" style="border-top:1px solid rgba(183,121,31,0.4);margin-top:3px;padding-top:3px;">
            <span class="scs-name" style="font-weight:700;color:var(--accent-gold);">‚àë Ukupno</span>
            <span class="scs-vals">
              <span class="scs-std" id="scs_C_total_std" style="font-weight:600;">Std ‚Äî</span>
              <span style="color:var(--text-muted)">+</span>
              <span class="scs-hid" id="scs_C_total_hid" style="font-weight:600;">Hidden ‚Äî</span>
              <span style="color:var(--text-muted)">=</span>
              <span class="scs-tot" id="scs_C_total_tot" style="font-size:0.86rem;">‚Äî</span>
            </span>
          </div>
        </div>
        <div id="scWarnings_C" class="sc-warnings"></div>
        <div class="scenario-live" id="liveStatsC">
          <div class="sl-title">üìä Live procena (meseƒçno)</div>
          <div class="sl-row"><span class="sl-lbl">‚ö™ PL drops / avg payout:</span><span class="sl-val" id="lsC_pl">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üü° GD drops / avg payout:</span><span class="sl-val" id="lsC_gd">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl">üíé DM drops / avg payout:</span><span class="sl-val" id="lsC_dm">‚Äî</span></div>
          <div class="sl-row"><span class="sl-lbl"><strong>Procenjeni JP RTP:</strong></span><span class="sl-rtp" id="lsC_rtp">‚Äî</span></div>
        </div>
        <button class="small secondary" id="runScenarioBtn_C" onclick="runScenario('C')">‚ñ∂ Run Scenario C</button>
      </div>
    </div>
    
    <h3 style="margin-top: 30px;">üìä Comparison Table</h3>
    <table id="comparisonTable">
      <thead>
        <tr>
          <th>Metrika</th>
          <th class="comparison-highlight">Current</th>
          <th id="scenarioA_header">Scenario A</th>
          <th id="scenarioB_header">Scenario B</th>
          <th id="scenarioC_header">Scenario C</th>
        </tr>
      </thead>
      <tbody id="comparisonBody">
        <tr>
          <td>JP RTP (%)</td>
          <td class="comparison-highlight" id="current_jpRtp">-</td>
          <td id="scenarioA_jpRtp">-</td>
          <td id="scenarioB_jpRtp">-</td>
          <td id="scenarioC_jpRtp">-</td>
        </tr>
        <tr>
          <td>Total RTP (%)</td>
          <td class="comparison-highlight" id="current_totalRtp">-</td>
          <td id="scenarioA_totalRtp">-</td>
          <td id="scenarioB_totalRtp">-</td>
          <td id="scenarioC_totalRtp">-</td>
        </tr>
        <tr>
          <td>House Edge (%)</td>
          <td class="comparison-highlight" id="current_houseEdge">-</td>
          <td id="scenarioA_houseEdge">-</td>
          <td id="scenarioB_houseEdge">-</td>
          <td id="scenarioC_houseEdge">-</td>
        </tr>
        <tr>
          <td>GGR (EUR)</td>
          <td class="comparison-highlight" id="current_ggr">-</td>
          <td id="scenarioA_ggr">-</td>
          <td id="scenarioB_ggr">-</td>
          <td id="scenarioC_ggr">-</td>
        </tr>
        <tr class="ct-sep-pl ct-label-pl">
          <td>‚ö™ Platinum Drops</td>
          <td class="comparison-highlight" id="current_plDrops">-</td>
          <td id="scenarioA_plDrops">-</td>
          <td id="scenarioB_plDrops">-</td>
          <td id="scenarioC_plDrops">-</td>
        </tr>
        <tr class="ct-label-pl">
          <td>‚ö™ Platinum Avg Drop</td>
          <td class="comparison-highlight" id="current_plAvg">-</td>
          <td id="scenarioA_plAvg">-</td>
          <td id="scenarioB_plAvg">-</td>
          <td id="scenarioC_plAvg">-</td>
        </tr>
        
        <tr class="ct-sep-gd ct-label-gd">
          <td>üü° Gold Drops</td>
          <td class="comparison-highlight" id="current_gdDrops">-</td>
          <td id="scenarioA_gdDrops">-</td>
          <td id="scenarioB_gdDrops">-</td>
          <td id="scenarioC_gdDrops">-</td>
        </tr>
        <tr class="ct-label-gd">
          <td>üü° Gold Avg Drop</td>
          <td class="comparison-highlight" id="current_gdAvg">-</td>
          <td id="scenarioA_gdAvg">-</td>
          <td id="scenarioB_gdAvg">-</td>
          <td id="scenarioC_gdAvg">-</td>
        </tr>
        
        <tr class="ct-sep-dm ct-label-dm">
          <td>üíé Diamond Drops</td>
          <td class="comparison-highlight" id="current_dmDrops">-</td>
          <td id="scenarioA_dmDrops">-</td>
          <td id="scenarioB_dmDrops">-</td>
          <td id="scenarioC_dmDrops">-</td>
        </tr>
        <tr class="ct-label-dm">
          <td>üíé Diamond Avg Drop</td>
          <td class="comparison-highlight" id="current_dmAvg">-</td>
          <td id="scenarioA_dmAvg">-</td>
          <td id="scenarioB_dmAvg">-</td>
          <td id="scenarioC_dmAvg">-</td>
        </tr>
        
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>üìä Grafikon ‚Äì JP RTP tokom simulacije</h2>
    <canvas id="rtpChart" width="1200" height="360"></canvas>
<div style="text-align:right; margin-top:10px;">
  <button class="secondary small" id="downloadChartBtn" style="display:none" onclick="downloadChart()">üíæ Save Chart as PNG</button>
</div>

    <p class="small-note" style="margin-top:15px;">
      <strong>X osa:</strong> Procesirani turnover (EUR) | <strong>Y osa:</strong> JP RTP (%)
    </p>
  </div>

  <div class="card">
    <h2>üí± Konvertor valuta - Svi Scenariji</h2>
    
    <div class="warning-box">
      ‚ö†Ô∏è <strong>VA≈ΩNO:</strong> Exchange rates su a≈æurirani za <strong>12. februar 2026</strong>.<br>
      Za crypto valute preporuƒçujemo kori≈°ƒáenje <strong>milli/micro prefiksa</strong> radi ƒçitljivosti.<br>
      <strong>‚ûï Dodaj Custom Valutu</strong> ako treba≈° a≈æurniji ili specifiƒçniji rate!
    </div>
    
    <div class="custom-currency-box">
      <h4>‚ûï Dodaj Custom Valutu</h4>
      <div class="custom-currency-grid">
        <div class="custom-currency-item">
          <label for="customCurrencyCode">Currency Code (3 slova)</label>
          <input type="text" id="customCurrencyCode" placeholder="npr. TRY, BRL, MXN" maxlength="3" style="text-transform: uppercase;">
        </div>
        <div class="custom-currency-item">
          <label for="customCurrencyRate">Exchange Rate prema EUR</label>
          <input type="number" id="customCurrencyRate" placeholder="npr. 35.50" step="0.01" min="0.0001">
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button class="green small" id="addCustomCurrencyBtn" style="margin: 0;">‚ûï Dodaj</button>
        </div>
      </div>
      <p class="small-note" style="margin-top: 8px; margin-bottom: 0;">
        üí° <strong>Fiat:</strong> Rate = koliko te valute za 1 EUR (1 EUR = 1.19 USD)<br>
        üí° <strong>Crypto:</strong> Rate = koliko EUR ko≈°ta 1 coin (1 BTC = 57,710 EUR)
      </p>
    </div>
    
    <div class="crypto-prefix-box" id="cryptoPrefixBox">
      <h4>‚Çø Crypto Prefix (za jake valute)</h4>
      <div class="prefix-grid">
        <div>
          <label for="cryptoPrefix">Izaberi prefix multiplier:</label>
          <select id="cryptoPrefix">
            <option value="1">None (1x) - Cela valuta</option>
            <option value="0.001" selected>milli (0.001x) - Hiljaditi deo (1 mBTC, 1 mETH)</option>
            <option value="0.000001">micro (0.000001x) - Milioniti deo (1 ŒºBTC, 1 ŒºETH)</option>
          </select>
          <p class="small-note" style="margin-top: 5px;">
            üí° <strong>Primer:</strong> 1 mBTC = 0.001 BTC (~57.71 EUR)
          </p>
        </div>
        <div>
          <label>Ekvivalent u EUR:</label>
          <input type="text" id="cryptoEquivalent" readonly style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; font-weight: bold;">
        </div>
      </div>
    </div>
    
    <div style="max-width: 600px;">
      <label for="convCurrency">Izaberi valutu (Top 50 Fiat + Top 10 Crypto)</label>
      <select id="convCurrency"></select>
      
      <div class="rate-display-box" id="rateDisplayBox" style="display:none;">
        <label style="margin: 0 0 5px 0; font-size: 12px; color: var(--accent-blue);">üìä Current Exchange Rate:</label>
        <input type="text" id="rateDisplay" readonly>
      </div>
      
      <button id="convertBtn">üí∞ Generi≈°i tabele za SVE scenarije</button>
    </div>
    <div id="convTableContainer" style="display:none; margin-top:20px; overflow-x:auto;">
      <h3 style="color: var(--accent-gold);">JP Configuration - <span id="selectedCurrency"></span></h3>
      
      <div class="currency-section">
        <h4>üìã Current Configuration (Main Setup)</h4>
        <table>
          <thead>
            <tr><th>JP Level</th><th>Standard %</th><th>Hidden %</th><th>Base Value</th><th>Min</th><th>Max</th><th>Min Bet</th></tr>
          </thead>
          <tbody id="convTableCurrent"></tbody>
        </table>
      </div>
      
      <div class="currency-section">
        <h4 id="convScenarioA_title">üìã Scenario A</h4>
        <table>
          <thead>
            <tr><th>JP Level</th><th>Standard %</th><th>Hidden %</th><th>Base Value</th><th>Min</th><th>Max</th><th>Min Bet</th></tr>
          </thead>
          <tbody id="convTableA"></tbody>
        </table>
      </div>
      
      <div class="currency-section">
        <h4 id="convScenarioB_title">üìã Scenario B</h4>
        <table>
          <thead>
            <tr><th>JP Level</th><th>Standard %</th><th>Hidden %</th><th>Base Value</th><th>Min</th><th>Max</th><th>Min Bet</th></tr>
          </thead>
          <tbody id="convTableB"></tbody>
        </table>
      </div>
      
      <div class="currency-section">
        <h4 id="convScenarioC_title">üìã Scenario C</h4>
        <table>
          <thead>
            <tr><th>JP Level</th><th>Standard %</th><th>Hidden %</th><th>Base Value</th><th>Min</th><th>Max</th><th>Min Bet</th></tr>
          </thead>
          <tbody id="convTableC"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Scenario results storage
  let scenarioResults = { A: null, B: null, C: null };

let currentResult = null;

function parseTurnover(str) {
  if (!str) return 0;
  return parseFloat(str.toString().replace(/,/g, '')) || 0;
}
function formatTurnover(num) {
  return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

const turnoverInput = document.getElementById('monthlyTurnoverEur');
turnoverInput.addEventListener('blur', () => {
  const val = parseTurnover(turnoverInput.value);
  turnoverInput.value = formatTurnover(val);
  updateIterationCount();
});

const granularityInput = document.getElementById('granularity');
granularityInput.addEventListener('input', updateIterationCount);

function updateIterationCount() {
  const turnover = parseTurnover(turnoverInput.value);
  const granularity = parseFloat(granularityInput.value) || 1;
  const iterations = Math.floor(turnover / granularity);
  document.getElementById('iterationCount').textContent = iterations.toLocaleString('en-US');
}
updateIterationCount();

function LCG(seed) {
  let m = 0x80000000, a = 1103515245, c = 12345;
  let state = seed ? seed : Math.floor(Math.random() * (m - 1));
  return function() {
    state = (a * state + c) % m;
    return state / (m - 1);
  };
}

function enforceBaseMinConstraint(prefix) {
  const baseInput = document.getElementById(`${prefix}_base`);
  const minInput = document.getElementById(`${prefix}_min`);
  
  const base = parseFloat(baseInput.value) || 0;
  const min = parseFloat(minInput.value) || 0;
  
  if (min === 0) return;
  if (base > min) {
    alert(`‚ö†Ô∏è GRE≈†KA!\n\nBase Value (${base}) ne mo≈æe biti VEƒÜI od Min Drop Zone (${min})!\n\nPostavljam Base = Min.`);
    baseInput.value = min.toFixed(2);
  }
  
  updateGapWarnings();
  validateConfiguration();
}

['pl', 'gd', 'dm'].forEach(prefix => {
  document.getElementById(`${prefix}_base`).addEventListener('blur', () => enforceBaseMinConstraint(prefix));
  document.getElementById(`${prefix}_min`).addEventListener('blur', () => enforceBaseMinConstraint(prefix));
});

function updateProgress(current, total) {
  const percentage = Math.round((current / total) * 100);
  const progressBar = document.getElementById('progressBar');
  const progressPercentage = document.getElementById('progressPercentage');
  const progressText = document.getElementById('progressText');
  const currentRun = document.getElementById('currentRun');
  
  progressBar.style.width = percentage + '%';
  progressPercentage.textContent = percentage + '%';
  progressText.textContent = `${current}/${total}`;
  currentRun.textContent = current;
}

function showProgress() {
  document.getElementById('progressContainer').style.display = 'block';
  document.getElementById('monteCarloResults').style.display = 'none';
  document.getElementById('runMonteCarloBtn').disabled = true;
  document.getElementById('totalRuns').textContent = '100';
}

function hideProgress() {
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('runMonteCarloBtn').disabled = false;
}

function updateGapWarnings() {
  const plBase = parseFloat(document.getElementById('pl_base').value) || 0;
  const plMin = parseFloat(document.getElementById('pl_min').value) || 0;
  const plGap = plMin - plBase;
  
  const plWarning = document.getElementById('pl_gap_warning');
  if (plGap <= 0 && (plMin > 0 || plBase > 0)) {
    plWarning.style.display = 'block';
  } else {
    plWarning.style.display = 'none';
  }
  
  const gdBase = parseFloat(document.getElementById('gd_base').value) || 0;
  const gdMin = parseFloat(document.getElementById('gd_min').value) || 0;
  const gdGap = gdMin - gdBase;
  document.getElementById('gd_gap_value').textContent = gdGap.toFixed(2) + ' EUR';
  
  const dmBase = parseFloat(document.getElementById('dm_base').value) || 0;
  const dmMin = parseFloat(document.getElementById('dm_min').value) || 0;
  const dmGap = dmMin - dmBase;
  document.getElementById('dm_gap_value').textContent = dmGap.toFixed(2) + ' EUR';
}

['pl', 'gd', 'dm'].forEach(prefix => {
  ['base', 'min'].forEach(field => {
    document.getElementById(`${prefix}_${field}`).addEventListener('input', updateGapWarnings);
  });
});
updateGapWarnings();


const currencies = {
  'USD': {name: 'US Dollar', rate: 1.19, type: 'fiat'},
  'EUR': {name: 'Euro', rate: 1.0, type: 'fiat'},
  'GBP': {name: 'British Pound', rate: 0.87, type: 'fiat'},
  'JPY': {name: 'Japanese Yen', rate: 181.6, type: 'fiat'},
  'CHF': {name: 'Swiss Franc', rate: 0.91, type: 'fiat'},
  'CAD': {name: 'Canadian Dollar', rate: 1.61, type: 'fiat'},
  'AUD': {name: 'Australian Dollar', rate: 1.67, type: 'fiat'},
  'CNY': {name: 'Chinese Yuan', rate: 7.85, type: 'fiat'},
  'SEK': {name: 'Swedish Krona', rate: 11.5, type: 'fiat'},
  'NOK': {name: 'Norwegian Krone', rate: 11.0, type: 'fiat'},
  'DKK': {name: 'Danish Krone', rate: 7.45, type: 'fiat'},
  'PLN': {name: 'Polish Zloty', rate: 4.21, type: 'fiat'},
  'CZK': {name: 'Czech Koruna', rate: 25.2, type: 'fiat'},
  'HUF': {name: 'Hungarian Forint', rate: 390.0, type: 'fiat'},
  'RON': {name: 'Romanian Leu', rate: 4.97, type: 'fiat'},
  'BGN': {name: 'Bulgarian Lev', rate: 1.96, type: 'fiat'},
  'HRK': {name: 'Croatian Kuna', rate: 7.53, type: 'fiat'},
  'RSD': {name: 'Serbian Dinar', rate: 117.0, type: 'fiat'},
  'ISK': {name: 'Icelandic Kr√≥na', rate: 150.0, type: 'fiat'},
  'AED': {name: 'UAE Dirham', rate: 4.04, type: 'fiat'},
  'SAR': {name: 'Saudi Riyal', rate: 4.12, type: 'fiat'},
  'ILS': {name: 'Israeli Shekel', rate: 4.0, type: 'fiat'},
  'ZAR': {name: 'South African Rand', rate: 20.5, type: 'fiat'},
  'EGP': {name: 'Egyptian Pound', rate: 54.0, type: 'fiat'},
  'TRY': {name: 'Turkish Lira', rate: 35.5, type: 'fiat'},
  'SGD': {name: 'Singapore Dollar', rate: 1.45, type: 'fiat'},
  'HKD': {name: 'Hong Kong Dollar', rate: 8.60, type: 'fiat'},
  'KRW': {name: 'South Korean Won', rate: 1450.0, type: 'fiat'},
  'INR': {name: 'Indian Rupee', rate: 107.76, type: 'fiat'},
  'IDR': {name: 'Indonesian Rupiah', rate: 17200.0, type: 'fiat'},
  'THB': {name: 'Thai Baht', rate: 38.5, type: 'fiat'},
  'MYR': {name: 'Malaysian Ringgit', rate: 5.0, type: 'fiat'},
  'PHP': {name: 'Philippine Peso', rate: 61.5, type: 'fiat'},
  'NZD': {name: 'New Zealand Dollar', rate: 1.78, type: 'fiat'},
  'MXN': {name: 'Mexican Peso', rate: 18.8, type: 'fiat'},
  'BRL': {name: 'Brazilian Real', rate: 5.45, type: 'fiat'},
  'ARS': {name: 'Argentine Peso', rate: 1050.0, type: 'fiat'},
  'CLP': {name: 'Chilean Peso', rate: 980.0, type: 'fiat'},
  'COP': {name: 'Colombian Peso', rate: 4250.0, type: 'fiat'},
  'PEN': {name: 'Peruvian Sol', rate: 4.10, type: 'fiat'},
  'RUB': {name: 'Russian Ruble', rate: 100.0, type: 'fiat'},
  'UAH': {name: 'Ukrainian Hryvnia', rate: 45.0, type: 'fiat'},
  'PKR': {name: 'Pakistani Rupee', rate: 305.0, type: 'fiat'},
  'BDT': {name: 'Bangladeshi Taka', rate: 120.0, type: 'fiat'},
  'VND': {name: 'Vietnamese Dong', rate: 27000.0, type: 'fiat'},
  'NGN': {name: 'Nigerian Naira', rate: 1650.0, type: 'fiat'},
  'KES': {name: 'Kenyan Shilling', rate: 143.0, type: 'fiat'},
  'TWD': {name: 'Taiwan Dollar', rate: 34.5, type: 'fiat'},
  'BTC': {name: 'Bitcoin', rate: 57710.0, type: 'crypto'},
  'ETH': {name: 'Ethereum', rate: 1616.93, type: 'crypto'},
  'USDT': {name: 'Tether (USD Stablecoin)', rate: 0.84, type: 'crypto'},
  'BNB': {name: 'Binance Coin', rate: 543.0, type: 'crypto'},
  'SOL': {name: 'Solana', rate: 67.15, type: 'crypto'},
  'XRP': {name: 'Ripple', rate: 1.16, type: 'crypto'},
  'USDC': {name: 'USD Coin (USD Stablecoin)', rate: 0.84, type: 'crypto'},
  'ADA': {name: 'Cardano', rate: 0.2151, type: 'crypto'},
  'AVAX': {name: 'Avalanche', rate: 7.28, type: 'crypto'},
  'DOGE': {name: 'Dogecoin', rate: 0.0754, type: 'crypto'}
};
window.currencies = currencies; // Expose globally for live rates


function populateCurrencySelect(){const sel=document.getElementById('convCurrency');sel.innerHTML='';const LIVE=['USD','GBP','RSD','CHF','JPY','CNY','TRY','INR','AUD','CAD','BRL','MXN','BTC','ETH','USDT','BNB','ADA','XRP','SOL','DOT','DOGE','LTC'];const fiatLive=[],fiatStatic=[],cryptoLive=[],cryptoStatic=[],custom=[];Object.keys(currencies).forEach(code=>{const curr=currencies[code];const isLive=LIVE.includes(code);if(curr.type==='fiat'){isLive?fiatLive.push(code):fiatStatic.push(code);}else if(curr.type==='crypto'){isLive?cryptoLive.push(code):cryptoStatic.push(code);}else if(curr.type==='custom'){custom.push(code);}});fiatLive.sort();fiatStatic.sort();cryptoLive.sort();cryptoStatic.sort();custom.sort();if(fiatLive.length>0){const g=document.createElement('optgroup');g.label='üü¢ FIAT Live Rates (Auto-updated)';fiatLive.forEach(code=>{const opt=document.createElement('option');opt.value=code;opt.textContent=`${code} - ${currencies[code].name} üü¢`;g.appendChild(opt);});sel.appendChild(g);}if(fiatStatic.length>0){const g=document.createElement('optgroup');g.label='‚ö™ FIAT Static (Feb 2026)';fiatStatic.forEach(code=>{const opt=document.createElement('option');opt.value=code;opt.textContent=`${code} - ${currencies[code].name}`;g.appendChild(opt);});sel.appendChild(g);}if(cryptoLive.length>0){const g=document.createElement('optgroup');g.label='üü¢ CRYPTO Live Rates (Auto-updated)';cryptoLive.forEach(code=>{const opt=document.createElement('option');opt.value=code;opt.textContent=`${code} - ${currencies[code].name} üü¢`;g.appendChild(opt);});sel.appendChild(g);}if(cryptoStatic.length>0){const g=document.createElement('optgroup');g.label='‚ö™ CRYPTO Static (Feb 2026)';cryptoStatic.forEach(code=>{const opt=document.createElement('option');opt.value=code;opt.textContent=`${code} - ${currencies[code].name}`;g.appendChild(opt);});sel.appendChild(g);}if(custom.length>0){const g=document.createElement('optgroup');g.label='‚ûï Custom Currencies';custom.forEach(code=>{const opt=document.createElement('option');opt.value=code;opt.textContent=`${code} - ${currencies[code].name}`;g.appendChild(opt);});sel.appendChild(g);}}
populateCurrencySelect();

function updateRateDisplay() {
  const code = document.getElementById('convCurrency').value;
  const currency = currencies[code];
  
  if (!currency) {
    document.getElementById('rateDisplayBox').style.display = 'none';
    return;
  }
  
  document.getElementById('rateDisplayBox').style.display = 'block';
  
  let displayText = '';
  if (currency.type === 'crypto') {
    const prefix = parseFloat(document.getElementById('cryptoPrefix').value);
    let prefixName = '';
    if (prefix === 0.001) prefixName = 'm';
    else if (prefix === 0.000001) prefixName = 'Œº';
    
    const effectiveRate = currency.rate * prefix;
    const formattedRate = effectiveRate >= 1 ? effectiveRate.toLocaleString('en-US', {maximumFractionDigits: 2}) : effectiveRate.toFixed(6);
    
    if (prefixName) {
      displayText = `1 ${prefixName}${code} = ${formattedRate} EUR | Base: 1 ${code} = ${currency.rate.toLocaleString('en-US', {maximumFractionDigits: 2})} EUR`;
    } else {
      displayText = `1 ${code} = ${currency.rate.toLocaleString('en-US', {maximumFractionDigits: 2})} EUR (1 coin ko≈°ta toliko EUR)`;
    }
  } else {
    displayText = `1 EUR = ${currency.rate.toLocaleString('en-US', {maximumFractionDigits: 4})} ${code}`;
  }
  
  document.getElementById('rateDisplay').value = displayText;
}

document.getElementById('convCurrency').addEventListener('change', () => {
  const code = document.getElementById('convCurrency').value;
  const currency = currencies[code];
  
  if (currency && currency.type === 'crypto') {
    document.getElementById('cryptoPrefixBox').style.display = 'block';
    
    if (currency.rate > 10000) {
      document.getElementById('cryptoPrefix').value = '0.001';
    } else if (currency.rate > 100) {
      document.getElementById('cryptoPrefix').value = '0.001';
    } else {
      document.getElementById('cryptoPrefix').value = '1';
    }
    
    updateCryptoEquivalent();
  } else {
    document.getElementById('cryptoPrefixBox').style.display = 'none';
  }
  
  updateRateDisplay();
});

document.getElementById('cryptoPrefix').addEventListener('change', function() {
  const code = document.getElementById('convCurrency').value;
  const currency = currencies[code];
  
  if (currency && currency.type === 'crypto' && this.value === '1' && currency.rate > 1000) {
    const currencyName = code === 'BTC' ? 'Bitcoin' : code === 'ETH' ? 'Ethereum' : code;
    alert(`‚ö†Ô∏è UPOZORENJE!\n\n${currencyName} je JAKO skupa valuta (${currency.rate.toLocaleString('en-US', {maximumFractionDigits: 2})} EUR).\n\nKori≈°ƒáenje "None (1x)" ƒáe generisati MALE DECIMALNE BROJEVE koji mogu biti te≈°ki za ƒçitanje!\n\nüí° PREPORUKA: Koristi "milli (0.001x)" prefix za ƒçitljivije vrednosti.`);
  }
  
  updateCryptoEquivalent();
  updateRateDisplay();
});

function updateCryptoEquivalent() {
  const code = document.getElementById('convCurrency').value;
  const currency = currencies[code];
  if (!currency || currency.type !== 'crypto') return;
  
  const prefix = parseFloat(document.getElementById('cryptoPrefix').value);
  const equivalent = (currency.rate * prefix);
  
  let prefixName = '';
  if (prefix === 1) prefixName = '';
  else if (prefix === 0.001) prefixName = 'm';
  else if (prefix === 0.000001) prefixName = 'Œº';
  
  let formattedEquiv;
  if (equivalent >= 1000) {
    formattedEquiv = equivalent.toLocaleString('en-US', {maximumFractionDigits: 2});
  } else if (equivalent >= 1) {
    formattedEquiv = equivalent.toFixed(2);
  } else {
    formattedEquiv = equivalent.toFixed(6);
  }
  
  document.getElementById('cryptoEquivalent').value = `1 ${prefixName}${code} ‚âà ${formattedEquiv} EUR`;
}

document.getElementById('addCustomCurrencyBtn').addEventListener('click', () => {
  const code = document.getElementById('customCurrencyCode').value.trim().toUpperCase();
  const rate = parseFloat(document.getElementById('customCurrencyRate').value);
  
  if (!code || code.length !== 3) {
    alert('‚ö†Ô∏è Unesi validan currency code (3 slova, npr. TRY, BRL, MXN)');
    return;
  }
  
  if (!rate || rate <= 0) {
    alert('‚ö†Ô∏è Unesi validan exchange rate (npr. 35.50)');
    return;
  }
  
  if (currencies[code]) {
    const overwrite = confirm(`Valuta ${code} veƒá postoji sa rate-om ${currencies[code].rate}.\n\n≈Ωeli≈° da je zamenji≈° sa ${rate}?`);
    if (!overwrite) return;
  }
  
  currencies[code] = {name: `Custom ${code}`, rate: rate, type: 'custom'};
  populateCurrencySelect();
  
  const sel = document.getElementById('convCurrency');
  sel.value = code;
  
  document.getElementById('customCurrencyCode').value = '';
  document.getElementById('customCurrencyRate').value = '';
  
  updateRateDisplay();
  
  alert(`‚úÖ Custom valuta ${code} dodana sa rate-om ${rate}!\n\nSada je mo≈æe≈° izabrati iz dropdown-a.`);
});

document.getElementById('customCurrencyCode').addEventListener('input', (e) => {
  e.target.value = e.target.value.toUpperCase();
});

function convertAndRound(amountEur, currencyCode, cryptoPrefix = 1) {
  if (!currencies[currencyCode]) return null;
  
  let effectiveRate = currencies[currencyCode].rate;
  if (currencies[currencyCode].type === 'crypto') {
    effectiveRate *= cryptoPrefix;
  }
  
  let value;
  
  if (currencies[currencyCode].type === 'crypto') {
    value = amountEur / effectiveRate;
  } else {
    value = amountEur * effectiveRate;
  }
  
  if (currencies[currencyCode].type === 'crypto') {
    if (cryptoPrefix >= 1) {
      if (value >= 1) {
        return Math.round(value * 100000) / 100000;
      } else if (value >= 0.001) {
        return Math.round(value * 100000000) / 100000000;
      } else if (value >= 0.00000001) {
        return parseFloat(value.toFixed(10));
      } else {
        return parseFloat(value.toExponential(4));
      }
    } else if (cryptoPrefix >= 0.001) {
      return Math.round(value * 100) / 100;
    } else if (cryptoPrefix >= 0.000001) {
      if (value >= 10) {
        return Math.round(value);
      } else {
        return Math.round(value * 10) / 10;
      }
    }
  } else {
    if (currencyCode === 'RSD' || currencyCode === 'HUF' || currencyCode === 'JPY' || currencyCode === 'KRW' || currencyCode === 'IDR' || currencyCode === 'VND') {
      if (value < 1000) value = Math.round(value / 10) * 10;
      else if (value < 10000) value = Math.round(value / 50) * 50;
      else if (value < 100000) value = Math.round(value / 100) * 100;
      else value = Math.round(value / 500) * 500;
    } else {
      if (value < 1) value = Math.round(value * 100) / 100;
      else if (value < 100) value = Math.round(value / 5) * 5;
      else if (value < 1000) value = Math.round(value / 10) * 10;
      else if (value < 10000) value = Math.round(value / 100) * 100;
      else value = Math.round(value / 1000) * 1000;
    }
  }
  
  return value;
}

function generateCurrencyTable(code, tbodyId, sourcePrefix) {
  const cryptoPrefix = currencies[code] && currencies[code].type === 'crypto' ? 
    parseFloat(document.getElementById('cryptoPrefix').value) : 1;
  
  const jpConfigs = [
    {name: 'Platinum', 
     base: parseFloat(document.getElementById(`${sourcePrefix}pl_base`).value)||0,
     min: parseFloat(document.getElementById(`${sourcePrefix}pl_min`).value)||0,
     max: parseFloat(document.getElementById(`${sourcePrefix}pl_max`).value)||0,
     betReq: parseFloat(document.getElementById('pl_bet_req').value)||0,
     std: parseFloat(document.getElementById(`${sourcePrefix}pl_std`).value)||0,
     hidden: parseFloat(document.getElementById(`${sourcePrefix}pl_hidden`).value)||0},
    {name: 'Gold', 
     base: parseFloat(document.getElementById(`${sourcePrefix}gd_base`).value)||0,
     min: parseFloat(document.getElementById(`${sourcePrefix}gd_min`).value)||0,
     max: parseFloat(document.getElementById(`${sourcePrefix}gd_max`).value)||0,
     betReq: parseFloat(document.getElementById('gd_bet_req').value)||0,
     std: parseFloat(document.getElementById(`${sourcePrefix}gd_std`).value)||0,
     hidden: parseFloat(document.getElementById(`${sourcePrefix}gd_hidden`).value)||0},
    {name: 'Diamond', 
     base: parseFloat(document.getElementById(`${sourcePrefix}dm_base`).value)||0,
     min: parseFloat(document.getElementById(`${sourcePrefix}dm_min`).value)||0,
     max: parseFloat(document.getElementById(`${sourcePrefix}dm_max`).value)||0,
     betReq: parseFloat(document.getElementById('dm_bet_req').value)||0,
     std: parseFloat(document.getElementById(`${sourcePrefix}dm_std`).value)||0,
     hidden: parseFloat(document.getElementById(`${sourcePrefix}dm_hidden`).value)||0}
  ];
  
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = '';
  
  jpConfigs.forEach(jp => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td');
    tdName.textContent = jp.name;
    tdName.style.textTransform = 'capitalize';
    tr.appendChild(tdName);
    
    ['std', 'hidden'].forEach(k => {
      const td = document.createElement('td');
      td.textContent = jp[k].toFixed(k==='std'?2:3) + '%';
      tr.appendChild(td);
    });
    
    ['base', 'min', 'max', 'betReq'].forEach(k => {
      const td = document.createElement('td');
      const val = convertAndRound(jp[k], code, cryptoPrefix);
      if (val === null) {
        td.textContent = '-';
      } else if (val === 0 && jp[k] === 0) {
        td.textContent = '0';
      } else {
        let decimals;
        if (currencies[code].type === 'crypto') {
          if (cryptoPrefix >= 1) {
            if (val >= 1) decimals = 5;
            else if (val >= 0.001) decimals = 8;
            else decimals = 10;
          } else if (cryptoPrefix >= 0.001) {
            decimals = 2;
          } else {
            decimals = val >= 10 ? 0 : 1;
          }
        } else {
          decimals = (k==='betReq'&&val<1) ? 2 : 0;
        }
        
        td.textContent = val.toLocaleString('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      }
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

document.getElementById('convertBtn').addEventListener('click', () => {
  const code = document.getElementById('convCurrency').value;
  const currency = currencies[code];
  
  generateCurrencyTable(code, 'convTableCurrent', '');
  generateCurrencyTable(code, 'convTableA', 'scenarioA_');
  generateCurrencyTable(code, 'convTableB', 'scenarioB_');
  generateCurrencyTable(code, 'convTableC', 'scenarioC_');
  
  document.getElementById('convScenarioA_title').textContent = 'üìã ' + document.getElementById('scenarioA_name').value;
  document.getElementById('convScenarioB_title').textContent = 'üìã ' + document.getElementById('scenarioB_name').value;
  document.getElementById('convScenarioC_title').textContent = 'üìã ' + document.getElementById('scenarioC_name').value;
  
  let currencyLabel = `${code} - ${currency.name}`;
  if (currency.type === 'crypto') {
    const prefix = parseFloat(document.getElementById('cryptoPrefix').value);
    let prefixName = '';
    if (prefix === 0.001) prefixName = 'm';
    else if (prefix === 0.000001) prefixName = 'Œº';
    
    if (prefixName) {
      currencyLabel += ` (${prefixName}${code})`;
    }
  }
  
  document.getElementById('selectedCurrency').textContent = currencyLabel;
  document.getElementById('convTableContainer').style.display = 'block';
});

function drawRtpChart(points, scenarios = {}) {
  const canvas = document.getElementById('rtpChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  const padding = { top: 40, right: 120, bottom: 60, left: 80 };

  ctx.clearRect(0, 0, width, height);

  // Combine all points to find ranges
  let allPoints = [...points];
  if (scenarios.A) allPoints = allPoints.concat(scenarios.A);
  if (scenarios.B) allPoints = allPoints.concat(scenarios.B);
  if (scenarios.C) allPoints = allPoints.concat(scenarios.C);

  if (allPoints.length === 0) return;

  const maxX = Math.max(...allPoints.map(p => p.x));
  const maxY = Math.max(...allPoints.map(p => p.y));
  const minY = Math.min(...allPoints.map(p => p.y));

  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;

  const scaleX = chartWidth / maxX;
  const scaleY = chartHeight / (maxY - minY);

  // Draw axes
  ctx.strokeStyle = '#2a3654';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(padding.left, padding.top);
  ctx.lineTo(padding.left, height - padding.bottom);
  ctx.lineTo(width - padding.right, height - padding.bottom);
  ctx.stroke();

  // Draw grid
  ctx.strokeStyle = '#1a2238';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (chartHeight * i / 5);
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(width - padding.right, y);
    ctx.stroke();

    const value = maxY - ((maxY - minY) * i / 5);
    ctx.fillStyle = '#6b7a94';
    ctx.font = '11px Inter';
    ctx.textAlign = 'right';
    ctx.fillText((value * 100).toFixed(2) + '%', padding.left - 10, y + 4);
  }

  // X-axis labels
  ctx.fillStyle = '#6b7a94';
  ctx.font = '11px Inter';
  ctx.textAlign = 'center';
  for (let i = 0; i <= 5; i++) {
    const x = padding.left + (chartWidth * i / 5);
    const value = (maxX * i / 5);
    ctx.fillText(value.toLocaleString('en-US', {maximumFractionDigits: 0}), x, height - padding.bottom + 20);
  }

  // Helper function to draw line
  const drawLine = (pts, color, width, label) => {
    if (!pts || pts.length === 0) return;

    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();

    pts.forEach((point, idx) => {
      const x = padding.left + (point.x * scaleX);
      const y = height - padding.bottom - ((point.y - minY) * scaleY);

      if (idx === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });

    ctx.stroke();
  };

  // Draw lines (scenarios first, then current on top)
  if (scenarios.A) drawLine(scenarios.A, '#10b981', 2, 'Scenario A');
  if (scenarios.B) drawLine(scenarios.B, '#fb923c', 2, 'Scenario B');
  if (scenarios.C) drawLine(scenarios.C, '#ef4444', 2, 'Scenario C');
  drawLine(points, '#f4c430', 3, 'Current');

  // Legend
  const legendX = width - padding.right + 10;
  let legendY = padding.top + 20;
  ctx.font = '12px Inter';
  ctx.textAlign = 'left';

  const legendItems = [
    { label: 'Current', color: '#f4c430', show: true },
    { label: 'Scenario A', color: '#10b981', show: scenarios.A },
    { label: 'Scenario B', color: '#fb923c', show: scenarios.B },
    { label: 'Scenario C', color: '#ef4444', show: scenarios.C }
  ];

  legendItems.forEach(item => {
    if (!item.show) return;

    ctx.fillStyle = item.color;
    ctx.fillRect(legendX, legendY - 8, 20, 3);
    ctx.fillStyle = '#e8ecf3';
    ctx.fillText(item.label, legendX + 25, legendY);
    legendY += 20;
  });

  // Title
  ctx.fillStyle = '#e8ecf3';
  ctx.font = 'bold 14px Inter';
  ctx.textAlign = 'center';
  ctx.fillText('JP RTP Progression', width / 2, 25);
}



function calculateNiceSteps(min, max, targetSteps) {
  const range = max - min;
  if (range === 0) return [min];
  
  const roughStep = range / targetSteps;
  
  const magnitude = Math.pow(10, Math.floor(Math.log10(roughStep)));
  const normalized = roughStep / magnitude;
  
  let niceStep;
  if (normalized < 1.5) niceStep = 1 * magnitude;
  else if (normalized < 3) niceStep = 2 * magnitude;
  else if (normalized < 7) niceStep = 5 * magnitude;
  else niceStep = 10 * magnitude;
  
  const steps = [];
  let current = Math.ceil(min / niceStep) * niceStep;
  
  while (current <= max) {
    steps.push(current);
    current += niceStep;
  }
  
  if (min === 0 && !steps.includes(0)) {
    steps.unshift(0);
  }
  
  return steps;
}

function formatAxisNumber(num) {
  if (num === 0) return '0';
  
  if (num >= 1000000) {
    const millions = num / 1000000;
    return millions % 1 === 0 ? millions + 'M' : millions.toFixed(1) + 'M';
  } else if (num >= 1000) {
    const thousands = num / 1000;
    return thousands % 1 === 0 ? thousands + 'K' : thousands.toFixed(1) + 'K';
  }
  
  return num.toLocaleString('en-US', {maximumFractionDigits: 0});
}

function validateConfiguration() {
  const warnings = [];
  
  const levels = [
    {name: 'Platinum', prefix: 'pl'},
    {name: 'Gold', prefix: 'gd'},
    {name: 'Diamond', prefix: 'dm'}
  ];
  
  levels.forEach(level => {
    const base = parseFloat(document.getElementById(`${level.prefix}_base`).value) || 0;
    const min = parseFloat(document.getElementById(`${level.prefix}_min`).value) || 0;
    const max = parseFloat(document.getElementById(`${level.prefix}_max`).value) || 0;
    const stdPct = (parseFloat(document.getElementById(`${level.prefix}_std`).value) || 0) / 100;
    const hiddenPct = (parseFloat(document.getElementById(`${level.prefix}_hidden`).value) || 0) / 100;
    
    if (base === 0 && min === 0 && max === 0) return;
    
    if (base > min && min > 0) {
      warnings.push({
        type: 'error',
        message: `<strong>${level.name}:</strong> Base Value (${base.toFixed(2)}) ne mo≈æe biti VEƒÜI od Min Drop Zone (${min.toFixed(2)})!`
      });
    }
    
    if (min >= max && max > 0) {
      warnings.push({
        type: 'error',
        message: `<strong>${level.name}:</strong> Min Drop Zone (${min.toFixed(2)}) mora biti manji od Max Drop Zone (${max.toFixed(2)})!`
      });
    }
    
    if (stdPct > 0 && hiddenPct > 0 && max > base) {
      const maxCycleTurnover = (max - base) / stdPct;
      const hiddenAccumulated = maxCycleTurnover * hiddenPct;
      const nextJpStart = base + hiddenAccumulated;
      
      if (nextJpStart > max) {
        const overflow = nextJpStart - max;
        const overflowPercent = (overflow / max) * 100;
        
        warnings.push({
          type: 'error',
          message: `<strong>${level.name} - HIDDEN OVERFLOW!</strong><br>
            Ako JP padne na Max (${max.toFixed(2)} EUR), hidden contribution ƒáe biti ${hiddenAccumulated.toFixed(2)} EUR.<br>
            Sledeƒái JP bi poƒçeo sa ${nextJpStart.toFixed(2)} EUR ≈°to je <strong>${overflow.toFixed(2)} EUR preko Max-a</strong> (${overflowPercent.toFixed(1)}%)!<br>
            <strong>RE≈†ENJE:</strong> Smanji Hidden % ili poveƒáaj Max vrednost.`
        });
      } else if (nextJpStart > max * 0.95) {
        warnings.push({
          type: 'warning',
          message: `<strong>${level.name} - UPOZORENJE:</strong> Hidden contribution (${hiddenAccumulated.toFixed(2)} EUR) je blizu Max-a. Sledeƒái JP bi poƒçeo sa ${nextJpStart.toFixed(2)} EUR (${((nextJpStart/max)*100).toFixed(1)}% Max-a).`
        });
      }
    }
  });
  
  const warningsDiv = document.getElementById('validationWarnings');
  warningsDiv.innerHTML = '';
  
  warnings.forEach(w => {
    const div = document.createElement('div');
    div.className = w.type;
    div.innerHTML = `${w.type === 'error' ? 'üö´' : '‚ö†Ô∏è'} ${w.message}`;
    warningsDiv.appendChild(div);
  });
  
  return warnings.filter(w => w.type === 'error').length === 0;
}

function runSingleSimulation(multiplier = 1.0, jpConfig = null) {
  const winBetRatioPercent = parseFloat(document.getElementById('winBetRatioPercent').value) || 0;
  const baseGameRtp = winBetRatioPercent / 100;
  const monthlyTurnoverEur = parseTurnover(document.getElementById('monthlyTurnoverEur').value);
  const granularity = parseFloat(document.getElementById('granularity').value) || 1;
  const seedVal = parseInt(document.getElementById('seed').value);
  const rng = isNaN(seedVal) ? Math.random : LCG(seedVal);
const effectiveMultiplier = jpConfig ? 1.0 : multiplier;
  const iterations = Math.floor(monthlyTurnoverEur / granularity);

  let levels;
  if (jpConfig) {
    levels = [
      {name: 'Platinum', 
       base: jpConfig.pl.base,
       minDrop: jpConfig.pl.min,
       maxDrop: jpConfig.pl.max,
       stdPct: ((parseFloat(document.getElementById('pl_std').value)||0)/100) * effectiveMultiplier,
       hidPct: ((parseFloat(document.getElementById('pl_hidden').value)||0)/100) * effectiveMultiplier},
      {name: 'Gold', 
       base: jpConfig.gd.base,
       minDrop: jpConfig.gd.min,
       maxDrop: jpConfig.gd.max,
       stdPct: ((parseFloat(document.getElementById('gd_std').value)||0)/100) * effectiveMultiplier,
       hidPct: ((parseFloat(document.getElementById('gd_hidden').value)||0)/100) * effectiveMultiplier},
      {name: 'Diamond', 
       base: jpConfig.dm.base,
       minDrop: jpConfig.dm.min,
       maxDrop: jpConfig.dm.max,
       stdPct: ((parseFloat(document.getElementById('dm_std').value)||0)/100) * effectiveMultiplier,
       hidPct: ((parseFloat(document.getElementById('dm_hidden').value)||0)/100) * effectiveMultiplier}
    ];
  } else {
    levels = [
      {name: 'Platinum', 
       base: parseFloat(document.getElementById('pl_base').value)||0,
       minDrop: parseFloat(document.getElementById('pl_min').value)||0,
       maxDrop: parseFloat(document.getElementById('pl_max').value)||0,
       stdPct: ((parseFloat(document.getElementById('pl_std').value)||0)/100) * multiplier,
       hidPct: ((parseFloat(document.getElementById('pl_hidden').value)||0)/100) * multiplier},
      {name: 'Gold', 
       base: parseFloat(document.getElementById('gd_base').value)||0,
       minDrop: parseFloat(document.getElementById('gd_min').value)||0,
       maxDrop: parseFloat(document.getElementById('gd_max').value)||0,
       stdPct: ((parseFloat(document.getElementById('gd_std').value)||0)/100) * multiplier,
       hidPct: ((parseFloat(document.getElementById('gd_hidden').value)||0)/100) * multiplier},
      {name: 'Diamond', 
       base: parseFloat(document.getElementById('dm_base').value)||0,
       minDrop: parseFloat(document.getElementById('dm_min').value)||0,
       maxDrop: parseFloat(document.getElementById('dm_max').value)||0,
       stdPct: ((parseFloat(document.getElementById('dm_std').value)||0)/100) * multiplier,
       hidPct: ((parseFloat(document.getElementById('dm_hidden').value)||0)/100) * multiplier}
    ];
  }

  let totalTurnoverProcessed = 0;

  const jpState = levels.map(l => {
    const range = l.maxDrop - l.minDrop;
    const randomVal = isNaN(seedVal) ? Math.random() : rng();
    const hitPoint = l.minDrop + randomVal * range;
    
    return {
      name: l.name, 
      currentValue: l.base, 
      fixedBase: l.base,
      hitPoint: hitPoint, 
      hiddenAcc: 0,
      dropCount: 0, 
      totalPaidOut: 0, 
      totalStdContrib: 0, 
      totalHiddenContrib: 0,
      minDrop: l.minDrop,
      maxDrop: l.maxDrop,
      gap: l.minDrop - l.base
    };
  });

  const rtpPoints = [];
  let jpPaidSoFar = 0;
  const sampleStep = Math.max(1, Math.floor(iterations / 200));

  for (let i = 0; i < iterations; i++) {
    const turnoverChunk = granularity;
    totalTurnoverProcessed += turnoverChunk;

    for (let j = 0; j < levels.length; j++) {
      const cfg = levels[j], st = jpState[j];
      const stdC = turnoverChunk * cfg.stdPct;
      const hidC = turnoverChunk * cfg.hidPct;
      
      st.currentValue += stdC;
      st.hiddenAcc += hidC;
      st.totalStdContrib += stdC;
      st.totalHiddenContrib += hidC;
      
      if (st.currentValue >= st.hitPoint) {
        const payout = st.currentValue;
        st.dropCount += 1;
        st.totalPaidOut += payout;
        jpPaidSoFar += payout;
        
        st.currentValue = st.fixedBase;
        st.hiddenAcc = 0;
        
        const range = cfg.maxDrop - cfg.minDrop;
        const randomVal = isNaN(seedVal) ? Math.random() : rng();
        st.hitPoint = cfg.minDrop + randomVal * range;
      }
    }
    
    if (i % sampleStep === 0 && totalTurnoverProcessed > 0) {
      rtpPoints.push({ x: totalTurnoverProcessed, y: jpPaidSoFar / totalTurnoverProcessed });
    }
  }

  const jpRtp = totalTurnoverProcessed > 0 ? (jpPaidSoFar / totalTurnoverProcessed) : 0;
  const totalRtp = baseGameRtp + jpRtp;
  
  return {
    jpState,
    jpRtp,
    totalRtp,
    baseGameRtp,
    rtpPoints,
    monthlyTurnoverEur
  };
}

function displayResults(result) {
  const { jpState, jpRtp, totalRtp, baseGameRtp, rtpPoints, monthlyTurnoverEur } = result;
  
  let jpTotalPaidOut = 0;
  let totalStdContrib = 0;
  let totalHidContrib = 0;
  
  const tbody = document.getElementById('jpStatsBody');
  tbody.innerHTML = '';

  jpState.forEach(st => {
    jpTotalPaidOut += st.totalPaidOut;
    totalStdContrib += st.totalStdContrib;
    totalHidContrib += st.totalHiddenContrib;
    
    const avgDrop = st.dropCount > 0 ? (st.totalPaidOut / st.dropCount) : 0;
    const tr = document.createElement('tr');
    function td(val, alignRight = true) {
      const cell = document.createElement('td');
      cell.textContent = typeof val === 'number' ? val.toLocaleString('en-US', {maximumFractionDigits: 2}) : val;
      if (!alignRight) cell.style.textAlign = 'left';
      return cell;
    }
    tr.appendChild(td(st.name, false));
    tr.appendChild(td(st.dropCount));
    tr.appendChild(td(avgDrop));
    tr.appendChild(td(st.totalPaidOut));
    tbody.appendChild(tr);
  });
  
  document.getElementById('totalStdCell').textContent = totalStdContrib.toLocaleString('en-US', {maximumFractionDigits: 2});
  document.getElementById('totalStdPctCell').textContent = ((totalStdContrib / monthlyTurnoverEur) * 100).toFixed(3) + '%';
  document.getElementById('totalHidCell').textContent = totalHidContrib.toLocaleString('en-US', {maximumFractionDigits: 2});
  document.getElementById('totalHidPctCell').textContent = ((totalHidContrib / monthlyTurnoverEur) * 100).toFixed(3) + '%';
  document.getElementById('totalContribCell').textContent = (totalStdContrib + totalHidContrib).toLocaleString('en-US', {maximumFractionDigits: 2});
  document.getElementById('totalContribPctCell').textContent = (((totalStdContrib + totalHidContrib) / monthlyTurnoverEur) * 100).toFixed(3) + '%';

  const houseEdge = 1 - totalRtp;
  
  const baseGameWins = monthlyTurnoverEur * baseGameRtp;
  const baseGameProfit = monthlyTurnoverEur - baseGameWins;
  const ggr = monthlyTurnoverEur - baseGameWins - jpTotalPaidOut;
  const ggrMargin = (ggr / monthlyTurnoverEur) * 100;
  
  document.getElementById('baseRtpCell').textContent = (baseGameRtp * 100).toFixed(2) + ' %';
  document.getElementById('jpRtpCell').textContent = (jpRtp * 100).toFixed(2) + ' %';
  document.getElementById('totalRtpCell').textContent = (totalRtp * 100).toFixed(2) + ' %';
  document.getElementById('houseEdgeCell').textContent = (houseEdge * 100).toFixed(2) + ' %';
  
  document.getElementById('totalPaidCell').textContent = jpTotalPaidOut.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' EUR';
  document.getElementById('baseGameProfitCell').textContent = baseGameProfit.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' EUR';
  document.getElementById('ggrCell').textContent = ggr.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' EUR';
  document.getElementById('ggrMarginCell').textContent = ggrMargin.toFixed(2) + ' %';
  
  drawRtpChart(rtpPoints);
  
document.getElementById('downloadChartBtn').style.display = 'inline-block';

  document.getElementById('current_jpRtp').textContent = (jpRtp * 100).toFixed(2);
  document.getElementById('current_totalRtp').textContent = (totalRtp * 100).toFixed(2);
  document.getElementById('current_houseEdge').textContent = (houseEdge * 100).toFixed(2);
  document.getElementById('current_ggr').textContent = ggr.toLocaleString('en-US', {maximumFractionDigits: 0});
  document.getElementById('current_plDrops').textContent = jpState[0].dropCount.toLocaleString();
  document.getElementById('current_plAvg').textContent = (jpState[0].dropCount > 0 ? (jpState[0].totalPaidOut / jpState[0].dropCount) : 0).toFixed(2);
  if(document.getElementById('current_plGap')) document.getElementById('current_plGap').textContent = jpState[0].gap.toFixed(2);
  document.getElementById('current_gdDrops').textContent = jpState[1].dropCount.toLocaleString();
  document.getElementById('current_gdAvg').textContent = (jpState[1].dropCount > 0 ? (jpState[1].totalPaidOut / jpState[1].dropCount) : 0).toFixed(2);
  if(document.getElementById('current_gdGap')) document.getElementById('current_gdGap').textContent = jpState[1].gap.toFixed(2);
  document.getElementById('current_dmDrops').textContent = jpState[2].dropCount.toLocaleString();
  document.getElementById('current_dmAvg').textContent = (jpState[2].dropCount > 0 ? (jpState[2].totalPaidOut / jpState[2].dropCount) : 0).toFixed(2);
  if(document.getElementById('current_dmGap')) document.getElementById('current_dmGap').textContent = jpState[2].gap.toFixed(0);
  
  document.getElementById('scenarioSection').style.display = 'block';


  // Enable Excel export button
  document.getElementById('exportExcelBtn').disabled = false;
}

function runScenario(scenario) {
  if (!currentResult) {
    alert('‚ö†Ô∏è Prvo pokreni glavnu simulaciju!');
    return;
  }
  // Provjeri validacijske gre≈°ke za ovaj scenario
  var warningsDiv = document.getElementById('scWarnings_' + scenario);
  if (warningsDiv && warningsDiv.querySelector('.error')) {
    alert('‚õî Scenario ' + scenario + ' ima gre≈°ke u konfiguraciji!\nIspravite ih pre pokretanja.');
    return;
  }

  const name = document.getElementById(`scenario${scenario}_name`).value;
  const gv = id => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };
  const stdFields = ['pl_std','pl_hidden','gd_std','gd_hidden','dm_std','dm_hidden'];
  const origVals = {};
  stdFields.forEach(f => {
    const el = document.getElementById(f);
    if (el) { origVals[f] = el.value; el.value = gv(`scenario${scenario}_${f}`); }
  });
  const jpConfig = {
    pl: { base: gv(`scenario${scenario}_pl_base`), min: gv(`scenario${scenario}_pl_min`), max: gv(`scenario${scenario}_pl_max`) },
    gd: { base: gv(`scenario${scenario}_gd_base`), min: gv(`scenario${scenario}_gd_min`), max: gv(`scenario${scenario}_gd_max`) },
    dm: { base: gv(`scenario${scenario}_dm_base`), min: gv(`scenario${scenario}_dm_min`), max: gv(`scenario${scenario}_dm_max`) }
  };

  document.getElementById(`scenario${scenario}_header`).textContent = name;

  const result = runSingleSimulation(1.0, jpConfig);
  stdFields.forEach(f => { const el = document.getElementById(f); if (el && origVals[f] !== undefined) el.value = origVals[f]; });

  // SAVE TO scenarioResults
  scenarioResults[scenario] = result;

  const { jpState, jpRtp, totalRtp, baseGameRtp, monthlyTurnoverEur } = result;

  const houseEdge = 1 - totalRtp;
  let jpTotalPaidOut = 0;
  jpState.forEach(st => jpTotalPaidOut += st.totalPaidOut);

  const baseGameWins = monthlyTurnoverEur * baseGameRtp;
  const ggr = monthlyTurnoverEur - baseGameWins - jpTotalPaidOut;

  // Update comparison table
  document.getElementById(`scenario${scenario}_jpRtp`).textContent = (jpRtp * 100).toFixed(2);
  document.getElementById(`scenario${scenario}_totalRtp`).textContent = (totalRtp * 100).toFixed(2);
  document.getElementById(`scenario${scenario}_houseEdge`).textContent = (houseEdge * 100).toFixed(2);
  document.getElementById(`scenario${scenario}_ggr`).textContent = ggr.toLocaleString('en-US', {maximumFractionDigits: 0});
  document.getElementById(`scenario${scenario}_plDrops`).textContent = jpState[0].dropCount.toLocaleString();
  document.getElementById(`scenario${scenario}_plAvg`).textContent = (jpState[0].dropCount > 0 ? (jpState[0].totalPaidOut / jpState[0].dropCount) : 0).toFixed(2);
  if(document.getElementById(`scenario${scenario}_plGap`)) document.getElementById(`scenario${scenario}_plGap`).textContent = jpState[0].gap.toFixed(2);
  document.getElementById(`scenario${scenario}_gdDrops`).textContent = jpState[1].dropCount.toLocaleString();
  document.getElementById(`scenario${scenario}_gdAvg`).textContent = (jpState[1].dropCount > 0 ? (jpState[1].totalPaidOut / jpState[1].dropCount) : 0).toFixed(2);
  if(document.getElementById(`scenario${scenario}_gdGap`)) document.getElementById(`scenario${scenario}_gdGap`).textContent = jpState[1].gap.toFixed(2);
  document.getElementById(`scenario${scenario}_dmDrops`).textContent = jpState[2].dropCount.toLocaleString();
  document.getElementById(`scenario${scenario}_dmAvg`).textContent = (jpState[2].dropCount > 0 ? (jpState[2].totalPaidOut / jpState[2].dropCount) : 0).toFixed(2);
  if(document.getElementById(`scenario${scenario}_dmGap`)) document.getElementById(`scenario${scenario}_dmGap`).textContent = jpState[2].gap.toFixed(0);

  // REDRAW CHART WITH ALL SCENARIOS
  drawRtpChart(currentResult.rtpPoints, {
    A: scenarioResults.A ? scenarioResults.A.rtpPoints : null,
    B: scenarioResults.B ? scenarioResults.B.rtpPoints : null,
    C: scenarioResults.C ? scenarioResults.C.rtpPoints : null
  });

document.getElementById('downloadChartBtn').style.display = 'inline-block';


  // Popuni liveStats: avg payout = (min+max)/2 UVIJEK, broj dropova iz simulacije
  const elById = id => document.getElementById(id);
  const lvConf = [
    { lv: 'pl', avgPayout: Math.round((jpConfig.pl.min + jpConfig.pl.max) / 2) },
    { lv: 'gd', avgPayout: Math.round((jpConfig.gd.min + jpConfig.gd.max) / 2) },
    { lv: 'dm', avgPayout: Math.round((jpConfig.dm.min + jpConfig.dm.max) / 2) }
  ];
  lvConf.forEach(function(lc, i) {
    var eVal = elById('ls' + scenario + '_' + lc.lv);
    if (!eVal) return;
    eVal.textContent = jpState[i].dropCount > 0
      ? jpState[i].dropCount.toLocaleString() + '√ó @ ~' + lc.avgPayout + ' EUR'
      : '‚Äî';
  });
  var rtpEl2 = elById('ls' + scenario + '_rtp');
  if (rtpEl2) rtpEl2.textContent = (jpRtp * 100).toFixed(3) + '%';

  alert(`‚úÖ ${name} scenario completed!\n\nJP RTP: ${(jpRtp * 100).toFixed(2)}%\nPlatinum: ${jpState[0].dropCount} dropova (GAP: ${jpState[0].gap.toFixed(2)} EUR)\nAvg Drop: ${(jpState[0].dropCount > 0 ? (jpState[0].totalPaidOut / jpState[0].dropCount) : 0).toFixed(2)} EUR`);

  // Enable Excel export
  document.getElementById('exportExcelBtn').disabled = false;
}

async function runMonteCarlo(){const _tv=parseTurnover(document.getElementById('monthlyTurnoverEur').value);if(!_tv||_tv<=0){alert('‚ö†Ô∏è Unesi meseƒçni turnover pre pokretanja!');return;}if(!validateConfiguration()){alert('Molim te ispravi gre≈°ke u konfiguraciji!');return;}const iter=100;const pc=document.getElementById('progressContainer');const pb=document.getElementById('progressBar');const pp=document.getElementById('progressPercentage');const cr=document.getElementById('currentRun');const tr=document.getElementById('totalRuns');const ss=document.getElementById('simulationSpeed');const et=document.getElementById('estimatedTime');const el=document.getElementById('elapsedTime');const prb=document.getElementById('pauseResumeBtn');const csb=document.getElementById('cancelSimBtn');const pi=document.getElementById('pauseIcon');const pt=document.getElementById('pauseText');pc.style.display='block';prb.style.display='inline-block';csb.style.display='inline-block';let isPaused=false,isCancelled=false;const startTime=Date.now();let lastUpdate=startTime;prb.onclick=()=>{isPaused=!isPaused;pi.textContent=isPaused?'‚ñ∂':'‚è∏';pt.textContent=isPaused?'Resume':'Pause';};csb.onclick=()=>{isCancelled=true;pc.style.display='none';prb.style.display='none';csb.style.display='none';alert('Simulacija prekinuta!');};tr.textContent=iter;const results=[];for(let run=0;run<iter;run++){while(isPaused&&!isCancelled)await new Promise(r=>setTimeout(r,100));if(isCancelled)return;document.getElementById('seed').value='';const result=runSingleSimulation();results.push(result);const curr=run+1;const pct=(curr/iter*100).toFixed(1);const now=Date.now();const elapsed=(now-startTime)/1000;const speed=curr/elapsed;const remaining=(iter-curr)/speed;pb.style.width=pct+'%';pp.textContent=pct+'%';cr.textContent=curr;if(now-lastUpdate>100||run%10===0){ss.textContent=`${speed.toFixed(0)} sim/s`;el.textContent=`${elapsed.toFixed(1)}s`;et.textContent=remaining>60?`${(remaining/60).toFixed(1)} min`:`${remaining.toFixed(0)}s`;lastUpdate=now;}if(run%5===0)await new Promise(r=>setTimeout(r,1));}setTimeout(()=>{pc.style.display='none';prb.style.display='none';csb.style.display='none';},1000);document.getElementById('monteCarloResults').style.display='block';const jpRtps=results.map(r=>r.jpRtp*100);const avgRtp=jpRtps.reduce((a,b)=>a+b,0)/jpRtps.length;const minRtp=Math.min(...jpRtps);const maxRtp=Math.max(...jpRtps);const variance=jpRtps.reduce((sum,val)=>sum+Math.pow(val-avgRtp,2),0)/jpRtps.length;const stdDev=Math.sqrt(variance);const z=1.96;const marginError=z*(stdDev/Math.sqrt(iter));const confLow=avgRtp-marginError;const confHigh=avgRtp+marginError;const volatility=(stdDev/avgRtp)*100;document.getElementById('mcAvgRtp').textContent=avgRtp.toFixed(3)+'%';document.getElementById('mcMinRtp').textContent=minRtp.toFixed(3)+'%';document.getElementById('mcMaxRtp').textContent=maxRtp.toFixed(3)+'%';document.getElementById('mcStdDev').textContent='¬±'+stdDev.toFixed(3)+'%';document.getElementById('mcConfidence').textContent=`[${confLow.toFixed(2)}%, ${confHigh.toFixed(2)}%]`;document.getElementById('mcVolatility').textContent=volatility.toFixed(2)+'%';const dropStats={'Platinum':[],'Gold':[],'Diamond':[]};results.forEach(r=>r.jpState.forEach(st=>dropStats[st.name].push(st.dropCount)));const mcDropsBody=document.getElementById('mcDropsBody');mcDropsBody.innerHTML='';['Platinum','Gold','Diamond'].forEach(name=>{const drops=dropStats[name];const avg=drops.reduce((a,b)=>a+b,0)/drops.length;const min=Math.min(...drops);const max=Math.max(...drops);const variance=drops.reduce((sum,val)=>sum+Math.pow(val-avg,2),0)/drops.length;const stdDev=Math.sqrt(variance);const tr=document.createElement('tr');tr.innerHTML=`<td style="text-align:left;">${name}</td><td>${avg.toFixed(0)}</td><td>${min}</td><td>${max}</td><td>¬±${stdDev.toFixed(0)}</td>`;mcDropsBody.appendChild(tr);});displayResults(results[results.length-1]);alert('‚úÖ Monte Carlo simulacija zavr≈°ena (100 runs)!');}

document.getElementById('runSimBtn').addEventListener('click', () => {
  const _tv = parseTurnover(document.getElementById('monthlyTurnoverEur').value);
  if (!_tv || _tv <= 0) {
    alert('‚ö†Ô∏è Unesi meseƒçni turnover (EUR) pre pokretanja simulacije!');
    document.getElementById('monthlyTurnoverEur').focus();
    return;
  }
  const _plOk = (parseFloat(document.getElementById('pl_min').value)||0) > 0;
  const _gdOk = (parseFloat(document.getElementById('gd_min').value)||0) > 0;
  const _dmOk = (parseFloat(document.getElementById('dm_min').value)||0) > 0;
  if (!_plOk && !_gdOk && !_dmOk) {
    alert('‚ö†Ô∏è Konfiguri≈°i bar jedan JP nivo (Min Drop Zone mora biti > 0)!');
    return;
  }
  if (!validateConfiguration()) {
    alert('Molim te ispravi gre≈°ke u konfiguraciji!');
    return;
  }
  
  document.getElementById('monteCarloResults').style.display = 'none';
  
  const result = runSingleSimulation(1.0, null);
  currentResult = result;
  displayResults(result);
});

document.getElementById('runMonteCarloBtn').addEventListener('click', runMonteCarlo);

['pl', 'gd', 'dm'].forEach(prefix => {
  ['base', 'min', 'max', 'std', 'hidden'].forEach(field => {
    document.getElementById(`${prefix}_${field}`).addEventListener('input', validateConfiguration);
  });
});

validateConfiguration();


// ========================================
// EXCEL EXPORT FUNKCIONALNOST
// ========================================

function exportToExcel() {
  if (!currentResult) {
    alert('‚ö†Ô∏è Prvo pokreni simulaciju!');
    return;
  }

  const wb = XLSX.utils.book_new();

  // ============ SHEET 1: Configuration ============
  const configData = [
    ['JP SIMULATOR - CONFIGURATION', '', '', ''],
    ['Generated:', new Date().toLocaleString('sr-RS'), '', ''],
    ['', '', '', ''],
    ['BASIC PARAMETERS', '', '', ''],
    ['Monthly Turnover (EUR)', formatTurnover(parseTurnover(document.getElementById('monthlyTurnoverEur').value)), '', ''],
    ['Win/Bet Ratio %', document.getElementById('winBetRatioPercent').value + '%', '', ''],
    ['Base Game RTP', (parseFloat(document.getElementById('winBetRatioPercent').value) / 100).toFixed(4), '', ''],
    ['Granularity', document.getElementById('granularity').value + ' EUR', '', ''],
    ['Seed', document.getElementById('seed').value || 'Random', '', ''],
    ['', '', '', ''],
    ['JACKPOT CONFIGURATION', 'Platinum', 'Gold', 'Diamond'],
    ['Base Value (EUR)', document.getElementById('pl_base').value, document.getElementById('gd_base').value, document.getElementById('dm_base').value],
    ['Min Drop Zone (EUR)', document.getElementById('pl_min').value, document.getElementById('gd_min').value, document.getElementById('dm_min').value],
    ['Max Drop Zone (EUR)', document.getElementById('pl_max').value, document.getElementById('gd_max').value, document.getElementById('dm_max').value],
    ['GAP (EUR)', (parseFloat(document.getElementById('pl_min').value) - parseFloat(document.getElementById('pl_base').value)).toFixed(2), (parseFloat(document.getElementById('gd_min').value) - parseFloat(document.getElementById('gd_base').value)).toFixed(2), (parseFloat(document.getElementById('dm_min').value) - parseFloat(document.getElementById('dm_base').value)).toFixed(2)],
    ['Bet Requirement (EUR)', document.getElementById('pl_bet_req').value, document.getElementById('gd_bet_req').value, document.getElementById('dm_bet_req').value],
    ['Standard Contribution %', document.getElementById('pl_std').value + '%', document.getElementById('gd_std').value + '%', document.getElementById('dm_std').value + '%'],
    ['Hidden Contribution %', document.getElementById('pl_hidden').value + '%', document.getElementById('gd_hidden').value + '%', document.getElementById('dm_hidden').value + '%'],
  ];

  const ws1 = XLSX.utils.aoa_to_sheet(configData);
  ws1['!cols'] = [{wch: 28}, {wch: 18}, {wch: 18}, {wch: 18}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Configuration');

  // ============ SHEET 2: Results ============
  const resultsData = [
    ['SIMULATION RESULTS', '', ''],
    ['', '', ''],
    ['OVERALL METRICS', '', ''],
    ['Base Game RTP', (currentResult.baseGameRtp * 100).toFixed(2) + '%', ''],
    ['Jackpot RTP', (currentResult.jpRtp * 100).toFixed(2) + '%', ''],
    ['Total RTP', (currentResult.totalRtp * 100).toFixed(2) + '%', ''],
    ['House Edge', ((1 - currentResult.totalRtp) * 100).toFixed(2) + '%', ''],
    ['', '', ''],
    ['JACKPOT STATISTICS', 'Platinum', 'Gold', 'Diamond'],
    ['Total Drops', currentResult.jpState[0].dropCount, currentResult.jpState[1].dropCount, currentResult.jpState[2].dropCount],
    ['Total Payouts (EUR)', currentResult.jpState[0].totalPaidOut.toFixed(2), currentResult.jpState[1].totalPaidOut.toFixed(2), currentResult.jpState[2].totalPaidOut.toFixed(2)],
    ['Average Payout (EUR)', (currentResult.jpState[0].dropCount > 0 ? currentResult.jpState[0].totalPaidOut / currentResult.jpState[0].dropCount : 0).toFixed(2), (currentResult.jpState[1].dropCount > 0 ? currentResult.jpState[1].totalPaidOut / currentResult.jpState[1].dropCount : 0).toFixed(2), (currentResult.jpState[2].dropCount > 0 ? currentResult.jpState[2].totalPaidOut / currentResult.jpState[2].dropCount : 0).toFixed(2)],
    ['Standard Contrib (EUR)', currentResult.jpState[0].totalStdContrib.toFixed(2), currentResult.jpState[1].totalStdContrib.toFixed(2), currentResult.jpState[2].totalStdContrib.toFixed(2)],
    ['Hidden Contrib (EUR)', currentResult.jpState[0].totalHiddenContrib.toFixed(2), currentResult.jpState[1].totalHiddenContrib.toFixed(2), currentResult.jpState[2].totalHiddenContrib.toFixed(2)],
    ['', '', ''],
    ['GGR ANALYSIS', '', ''],
    ['Total JP Paid', (currentResult.jpState[0].totalPaidOut + currentResult.jpState[1].totalPaidOut + currentResult.jpState[2].totalPaidOut).toFixed(2) + ' EUR', ''],
    ['Base Game Profit', (currentResult.monthlyTurnoverEur * (1 - currentResult.baseGameRtp)).toFixed(2) + ' EUR', ''],
    ['GGR (Gross Gaming Revenue)', (currentResult.monthlyTurnoverEur - (currentResult.monthlyTurnoverEur * currentResult.baseGameRtp) - (currentResult.jpState[0].totalPaidOut + currentResult.jpState[1].totalPaidOut + currentResult.jpState[2].totalPaidOut)).toFixed(2) + ' EUR', ''],
  ];

  const ws2 = XLSX.utils.aoa_to_sheet(resultsData);
  ws2['!cols'] = [{wch: 30}, {wch: 20}, {wch: 20}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Results');

  // ============ SHEET 3: Scenarios (ako postoje) ============
  if (scenarioResults.A || scenarioResults.B || scenarioResults.C) {
    const scenData = [
      ['SCENARIO COMPARISON', '', '', '', ''],
      ['', '', '', '', ''],
      ['Metric', 'Current', 'Scenario A', 'Scenario B', 'Scenario C'],
    ];

    const addRow = (label, curr, a, b, c) => {
      scenData.push([
        label,
        curr || '-',
        a || '-',
        b || '-',
        c || '-'
      ]);
    };

    addRow('JP RTP (%)', 
      (currentResult.jpRtp * 100).toFixed(2) + '%',
      scenarioResults.A ? (scenarioResults.A.jpRtp * 100).toFixed(2) + '%' : '-',
      scenarioResults.B ? (scenarioResults.B.jpRtp * 100).toFixed(2) + '%' : '-',
      scenarioResults.C ? (scenarioResults.C.jpRtp * 100).toFixed(2) + '%' : '-'
    );

    addRow('Total RTP (%)',
      (currentResult.totalRtp * 100).toFixed(2) + '%',
      scenarioResults.A ? (scenarioResults.A.totalRtp * 100).toFixed(2) + '%' : '-',
      scenarioResults.B ? (scenarioResults.B.totalRtp * 100).toFixed(2) + '%' : '-',
      scenarioResults.C ? (scenarioResults.C.totalRtp * 100).toFixed(2) + '%' : '-'
    );

    addRow('House Edge (%)',
      ((1 - currentResult.totalRtp) * 100).toFixed(2) + '%',
      scenarioResults.A ? ((1 - scenarioResults.A.totalRtp) * 100).toFixed(2) + '%' : '-',
      scenarioResults.B ? ((1 - scenarioResults.B.totalRtp) * 100).toFixed(2) + '%' : '-',
      scenarioResults.C ? ((1 - scenarioResults.C.totalRtp) * 100).toFixed(2) + '%' : '-'
    );

    scenData.push(['', '', '', '', '']);
    scenData.push(['PLATINUM JACKPOT', '', '', '', '']);

    addRow('Drops',
      currentResult.jpState[0].dropCount,
      scenarioResults.A ? scenarioResults.A.jpState[0].dropCount : '-',
      scenarioResults.B ? scenarioResults.B.jpState[0].dropCount : '-',
      scenarioResults.C ? scenarioResults.C.jpState[0].dropCount : '-'
    );

    addRow('Average Drop (EUR)',
      (currentResult.jpState[0].dropCount > 0 ? currentResult.jpState[0].totalPaidOut / currentResult.jpState[0].dropCount : 0).toFixed(2),
      scenarioResults.A && scenarioResults.A.jpState[0].dropCount > 0 ? (scenarioResults.A.jpState[0].totalPaidOut / scenarioResults.A.jpState[0].dropCount).toFixed(2) : '-',
      scenarioResults.B && scenarioResults.B.jpState[0].dropCount > 0 ? (scenarioResults.B.jpState[0].totalPaidOut / scenarioResults.B.jpState[0].dropCount).toFixed(2) : '-',
      scenarioResults.C && scenarioResults.C.jpState[0].dropCount > 0 ? (scenarioResults.C.jpState[0].totalPaidOut / scenarioResults.C.jpState[0].dropCount).toFixed(2) : '-'
    );

    scenData.push(['', '', '', '', '']); scenData.push(['GOLD JACKPOT', '', '', '', '']);
    addRow('Drops', currentResult.jpState[1].dropCount, scenarioResults.A ? scenarioResults.A.jpState[1].dropCount : '-', scenarioResults.B ? scenarioResults.B.jpState[1].dropCount : '-', scenarioResults.C ? scenarioResults.C.jpState[1].dropCount : '-');
    addRow('Average Drop (EUR)', currentResult.jpState[1].dropCount > 0 ? (currentResult.jpState[1].totalPaidOut/currentResult.jpState[1].dropCount).toFixed(2) : '-', scenarioResults.A && scenarioResults.A.jpState[1].dropCount > 0 ? (scenarioResults.A.jpState[1].totalPaidOut/scenarioResults.A.jpState[1].dropCount).toFixed(2) : '-', scenarioResults.B && scenarioResults.B.jpState[1].dropCount > 0 ? (scenarioResults.B.jpState[1].totalPaidOut/scenarioResults.B.jpState[1].dropCount).toFixed(2) : '-', scenarioResults.C && scenarioResults.C.jpState[1].dropCount > 0 ? (scenarioResults.C.jpState[1].totalPaidOut/scenarioResults.C.jpState[1].dropCount).toFixed(2) : '-');
    scenData.push(['', '', '', '', '']); scenData.push(['DIAMOND JACKPOT', '', '', '', '']);
    addRow('Drops', currentResult.jpState[2].dropCount, scenarioResults.A ? scenarioResults.A.jpState[2].dropCount : '-', scenarioResults.B ? scenarioResults.B.jpState[2].dropCount : '-', scenarioResults.C ? scenarioResults.C.jpState[2].dropCount : '-');
    addRow('Average Drop (EUR)', currentResult.jpState[2].dropCount > 0 ? (currentResult.jpState[2].totalPaidOut/currentResult.jpState[2].dropCount).toFixed(2) : '-', scenarioResults.A && scenarioResults.A.jpState[2].dropCount > 0 ? (scenarioResults.A.jpState[2].totalPaidOut/scenarioResults.A.jpState[2].dropCount).toFixed(2) : '-', scenarioResults.B && scenarioResults.B.jpState[2].dropCount > 0 ? (scenarioResults.B.jpState[2].totalPaidOut/scenarioResults.B.jpState[2].dropCount).toFixed(2) : '-', scenarioResults.C && scenarioResults.C.jpState[2].dropCount > 0 ? (scenarioResults.C.jpState[2].totalPaidOut/scenarioResults.C.jpState[2].dropCount).toFixed(2) : '-');

    const ws3 = XLSX.utils.aoa_to_sheet(scenData);
    ws3['!cols'] = [{wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, ws3, 'Scenarios');
  }

  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
  const filename = `JP_Simulation_${timestamp}.xlsx`;

  XLSX.writeFile(wb, filename);

  const scenCount = [scenarioResults.A, scenarioResults.B, scenarioResults.C].filter(x => x).length;
  const msg = scenCount > 0 
    ? `‚úÖ Excel fajl exportovan sa ${scenCount} scenarija!` 
    : `‚úÖ Excel fajl exportovan!`;

  alert(`${msg}\n\nFajl: ${filename}\n\nProveri folder Downloads.`);
}

// Event listener za Export dugme
document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);



// ============ LIVE RATES SA POLLING ZA window.currencies ============
const CORS_PROXY='https://corsproxy.io/?';
const LIVE_RATES_CURRENCIES=['USD','GBP','RSD','CHF','JPY','CNY','TRY','INR','AUD','CAD','BRL','MXN','BTC','ETH','USDT','BNB','ADA','XRP','SOL','DOT','DOGE','LTC'];
let cachedRates=null;
const FALLBACK_RATES={USD:1.19,GBP:0.871,RSD:117.35,CHF:0.914,JPY:181.58,CNY:8.2,TRY:51.88,INR:107.56,AUD:1.67,CAD:1.62,BRL:6.15,MXN:20.43,BTC:56129,ETH:1641,USDT:0.842,BNB:514,ADA:0.221,XRP:1.15,SOL:66.4,DOT:1.07,DOGE:0.078,LTC:44.7};

function waitForCurrencies(callback,maxAttempts=50){
  let attempts=0;
  console.log('‚è≥ Waiting for window.currencies...');
  const check=setInterval(()=>{
    attempts++;
    if(typeof window.currencies!=='undefined'&&window.currencies){
      clearInterval(check);
      console.log(`‚úÖ window.currencies ready! (${attempts} attempts, ${attempts*100}ms)`);
      callback();
    }else if(attempts>=maxAttempts){
      clearInterval(check);
      console.error(`‚ùå window.currencies NOT found after ${maxAttempts*100}ms!`);
    }
  },100);
}

function applyRatesToCurrencies(rates){
  if(typeof window.currencies==='undefined'){
    console.error('‚ùå window.currencies is STILL undefined!');
    return 0;
  }
  let updateCount=0;
  console.log('üì¶ Applying rates...');
  Object.keys(rates).forEach(code=>{
    if(window.currencies[code]){
      if(rates[code]!==undefined&&rates[code]!==null){
        const old=window.currencies[code].rate;
        window.currencies[code].rate=rates[code];
        updateCount++;
        const diff=Math.abs(old-rates[code]);
        console.log(`üìä ${code}: ${old.toFixed(2)} ‚Üí ${rates[code].toFixed(2)} ${diff>0.01?'‚úÖ':'‚ö™'}`);
      }
    }
  });
  console.log(`‚úÖ Updated ${updateCount}/${Object.keys(rates).length} currencies`);

  console.log('üîÑ Refreshing display...');
  const convCurrency=document.getElementById('convCurrency');
  if(convCurrency&&convCurrency.value){
    console.log(`   Selection: ${convCurrency.value}`);
    if(typeof updateRateDisplay==='function'){
      try{updateRateDisplay();console.log('‚úÖ updateRateDisplay() OK');}
      catch(e){console.error('‚ùå updateRateDisplay() failed:',e.message);}
    }
    try{
      convCurrency.dispatchEvent(new Event('change',{bubbles:true}));
      console.log('‚úÖ change event OK');
    }catch(e){console.error('‚ùå change event failed:',e.message);}
  }
  return updateCount;
}

async function fetchLiveExchangeRates(){
  const btn=document.getElementById('refreshRatesBtn');
  const txt=document.getElementById('refreshText');
  const ts=document.getElementById('ratesTimestamp');
  console.log('üîÑ Fetching live rates...');
  if(btn){btn.disabled=true;txt.textContent='Loading...';}
  try{
    console.log('üì° FIAT API...');
    const fiatAPI='https://api.exchangerate-api.com/v4/latest/EUR';
    const fiatRes=await fetch(CORS_PROXY+encodeURIComponent(fiatAPI));
    if(!fiatRes.ok)throw new Error('FIAT failed');
    const fiatData=await fiatRes.json();
    console.log('‚úÖ FIAT OK');
    console.log('üì° CRYPTO API...');
    const cryptoAPI='https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether,binancecoin,cardano,ripple,solana,polkadot,dogecoin,litecoin&vs_currencies=eur';
    const cryptoRes=await fetch(CORS_PROXY+encodeURIComponent(cryptoAPI));
    if(!cryptoRes.ok)throw new Error('CRYPTO failed');
    const cryptoData=await cryptoRes.json();
    console.log('‚úÖ CRYPTO OK');
    const liveRates={
      USD:fiatData.rates.USD,GBP:fiatData.rates.GBP,RSD:fiatData.rates.RSD,CHF:fiatData.rates.CHF,
      JPY:fiatData.rates.JPY,CNY:fiatData.rates.CNY,TRY:fiatData.rates.TRY,INR:fiatData.rates.INR,
      AUD:fiatData.rates.AUD,CAD:fiatData.rates.CAD,BRL:fiatData.rates.BRL,MXN:fiatData.rates.MXN,
      BTC:cryptoData.bitcoin?.eur,ETH:cryptoData.ethereum?.eur,USDT:cryptoData.tether?.eur,
      BNB:cryptoData.binancecoin?.eur,ADA:cryptoData.cardano?.eur,XRP:cryptoData.ripple?.eur,
      SOL:cryptoData.solana?.eur,DOT:cryptoData.polkadot?.eur,DOGE:cryptoData.dogecoin?.eur,LTC:cryptoData.litecoin?.eur
    };
    console.log('‚úÖ Live rates fetched!',liveRates);
    cachedRates=liveRates;
    applyRatesToCurrencies(liveRates);
    const now=new Date();
    const timeStr=now.toLocaleTimeString('sr-RS',{hour:'2-digit',minute:'2-digit'});
    if(ts){ts.textContent=`‚úÖ Live: ${timeStr}`;ts.style.color='var(--accent-green)';}
    if(btn){btn.disabled=false;txt.textContent='Refresh';}
    return liveRates;
  }catch(err){
    console.error('‚ùå FAILED:',err.message);
    console.log('üîÑ Using FALLBACK...');
    applyRatesToCurrencies(FALLBACK_RATES);
    if(ts){ts.textContent='‚ö†Ô∏è Fallback rates';ts.style.color='var(--accent-gold)';}
    if(btn){btn.disabled=false;txt.textContent='Retry';}
    return FALLBACK_RATES;
  }
}

// ============ THEME ============
(function(){
  window.updateChartTheme=function(){
    if(window.myRtpChart){
      const isLight=document.body.classList.contains('light-mode');
      const txtCol=isLight?'#2d3748':'#98a7c0';
      const gridCol=isLight?'rgba(203,213,224,0.3)':'rgba(42,54,84,0.5)';
      window.myRtpChart.options.scales.x.ticks.color=txtCol;
      window.myRtpChart.options.scales.x.grid.color=gridCol;
      window.myRtpChart.options.scales.y.ticks.color=txtCol;
      window.myRtpChart.options.scales.y.grid.color=gridCol;
      if(window.myRtpChart.options.plugins?.legend)window.myRtpChart.options.plugins.legend.labels.color=txtCol;
      window.myRtpChart.update('none');
    }
  };
  function initTheme(){
    const toggle=document.getElementById('themeToggle');
    const icon=document.getElementById('themeIcon');
    const text=document.getElementById('themeText');
    if(!toggle)return;
    const saved=localStorage.getItem('jp-theme');
    if(saved==='light'){
      document.body.classList.add('light-mode');
      icon.textContent='üåô';text.textContent='Dark Mode';
      setTimeout(()=>window.updateChartTheme?.(),200);
    }else{
      icon.textContent='‚òÄÔ∏è';text.textContent='Light Mode';
      if(!saved)localStorage.setItem('jp-theme','dark');
    }
    toggle.addEventListener('click',function(){
      document.body.classList.toggle('light-mode');
      const isLight=document.body.classList.contains('light-mode');
      icon.textContent=isLight?'üåô':'‚òÄÔ∏è';
      text.textContent=isLight?'Dark Mode':'Light Mode';
      localStorage.setItem('jp-theme',isLight?'light':'dark');
      window.updateChartTheme?.();
    });
  }
  function initLiveRates(){
    const btn=document.getElementById('refreshRatesBtn');
    if(btn)btn.addEventListener('click',()=>{console.log('üîÑ Manual refresh');fetchLiveExchangeRates();});
    waitForCurrencies(()=>{console.log('üöÄ Starting fetch...');fetchLiveExchangeRates();});
    setInterval(fetchLiveExchangeRates,5*60*1000);
    console.log('‚úÖ Live rates system initialized');
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',function(){initTheme();initLiveRates();});
  }else{
    initTheme();initLiveRates();
  }
})();

// ===== PNG DOWNLOAD =====
function downloadChart() {
  const canvas = document.getElementById('rtpChart');
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const hasData = imageData.data.some((val, i) => i % 4 !== 3 && val !== 0);
  if (!hasData) { alert('Nema podataka. Pokreni simulaciju!'); return; }
  const now = new Date();
  const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}`;
  const link = document.createElement('a');
  link.download = `JPRTPChart_${dateStr}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// ===== SMART BUILDER =====

// ===== SCENARIO LIVE STATS (ispravna formula sa BASE) =====
(function() {
  function calcLive(s) {
    try {
      var gv=function(id){var el=document.getElementById(id);return el?parseFloat(el.value)||0:0;};
      var torEl=document.getElementById('monthlyTurnoverEur');
      var T=torEl?(parseTurnover(torEl.value)||1000000):1000000;

      var stdPl=gv('scenario'+s+'_pl_std')/100,  hidPl=gv('scenario'+s+'_pl_hidden')/100;
      var stdGd=gv('scenario'+s+'_gd_std')/100,  hidGd=gv('scenario'+s+'_gd_hidden')/100;
      var stdDm=gv('scenario'+s+'_dm_std')/100,  hidDm=gv('scenario'+s+'_dm_hidden')/100;

      var avgPl=(gv('scenario'+s+'_pl_min')+gv('scenario'+s+'_pl_max'))/2;
      var avgGd=(gv('scenario'+s+'_gd_min')+gv('scenario'+s+'_gd_max'))/2;
      var avgDm=(gv('scenario'+s+'_dm_min')+gv('scenario'+s+'_dm_max'))/2;

      var bPl=gv('scenario'+s+'_pl_base');
      var bGd=gv('scenario'+s+'_gd_base');
      var bDm=gv('scenario'+s+'_dm_base');

      // GAP = raspon koji std treba da popuni od base do avgDrop
      var gPl=avgPl-bPl, gGd=avgGd-bGd, gDm=avgDm-bDm;

      // Drops = std akumulacija / GAP
      var drPl=gPl>0?Math.round(stdPl*T/gPl):0;
      var drGd=gGd>0?Math.round(stdGd*T/gGd):0;
      var drDm=gDm>0?Math.round(stdDm*T/gDm):0;

      // Avg payout = avgDrop + hiddenAcc pri dropu
      var payPl=gPl>0?avgPl+(stdPl>0?(hidPl/stdPl)*gPl:0):avgPl;
      var payGd=gGd>0?avgGd+(stdGd>0?(hidGd/stdGd)*gGd:0):avgGd;
      var payDm=gDm>0?avgDm+(stdDm>0?(hidDm/stdDm)*gDm:0):avgDm;

      var jpRtp=(drPl*payPl+drGd*payGd+drDm*payDm)/T*100;

      var fmt=function(dr,pay){return dr+'√ó @ ~'+pay.toFixed(0)+' EUR';};
      var se=function(id){return document.getElementById(id);};
      if(se('ls'+s+'_pl'))se('ls'+s+'_pl').textContent=avgPl>0?fmt(drPl,payPl):'‚Äî';
      if(se('ls'+s+'_gd'))se('ls'+s+'_gd').textContent=avgGd>0?fmt(drGd,payGd):'‚Äî';
      if(se('ls'+s+'_dm'))se('ls'+s+'_dm').textContent=avgDm>0?fmt(drDm,payDm):'‚Äî';
      if(se('ls'+s+'_rtp'))se('ls'+s+'_rtp').textContent=jpRtp>0?jpRtp.toFixed(3)+'%':'‚Äî';
    }catch(e){}
  }
  function attachListeners(s){
    var fields=['pl_std','pl_hidden','pl_min','pl_max','pl_base','gd_std','gd_hidden','gd_min','gd_max','gd_base','dm_std','dm_hidden','dm_min','dm_max','dm_base'];
    fields.forEach(function(f){var el=document.getElementById('scenario'+s+'_'+f);if(el)el.addEventListener('input',function(){calcLive(s);});});
    var tor=document.getElementById('monthlyTurnoverEur');
    if(tor)tor.addEventListener('input',function(){['A','B','C'].forEach(function(x){calcLive(x);});});
  }
  function init(){['A','B','C'].forEach(function(s){attachListeners(s);calcLive(s);});}
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
})();
// ===== END LIVE STATS =====


// =============================================
// SCENARIO CONTRIBUTION TOTALS & VALIDATION
// =============================================

// Smart decimal formatter - uklanja nepotrebne nule
function fmtPct(val) {
  if (val === 0) return '0%';
  // Ako je ceo broj ili ima do 2 decimale, koristi to
  if (val >= 1) return val.toFixed(val % 1 === 0 ? 0 : 2) + '%';
  // Za manje vrednosti, naƒëi pravu preciznost (maks 4 decimale, ali bez trailing nula)
  var s = parseFloat(val.toFixed(4)).toString();
  return s + '%';
}

function fmtRate(val) {
  if (val === 0) return '0';
  var s = parseFloat(val.toFixed(6)).toString();
  return s + ' EUR/EUR';
}

function updateAllScenarioContribs(letter) {
  var levels = [
    { prefix: 'pl', idPfx: 'pl' },
    { prefix: 'gd', idPfx: 'gd' },
    { prefix: 'dm', idPfx: 'dm' }
  ];

  levels.forEach(function(lv) {
    var std    = parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_std').value)    || 0;
    var hidden = parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_hidden').value) || 0;
    var total  = std + hidden;

    var elStd = document.getElementById('scs_' + letter + '_' + lv.idPfx + '_std');
    var elHid = document.getElementById('scs_' + letter + '_' + lv.idPfx + '_hid');
    var elTot = document.getElementById('scs_' + letter + '_' + lv.idPfx + '_tot');

    if (elStd) elStd.textContent = 'Std ' + fmtPct(std);
    if (elHid) elHid.textContent = 'Hidden ' + fmtPct(hidden);
    if (elTot) elTot.textContent = '= ' + fmtPct(total);
  });
  var ts=0,th=0; ['pl','gd','dm'].forEach(function(lv){ts+=(parseFloat(document.getElementById('scenario'+letter+'_'+lv+'_std').value)||0);th+=(parseFloat(document.getElementById('scenario'+letter+'_'+lv+'_hidden').value)||0);});
  var eTS=document.getElementById('scs_'+letter+'_total_std');
  var eTH=document.getElementById('scs_'+letter+'_total_hid');
  var eTT=document.getElementById('scs_'+letter+'_total_tot');
  if(eTS)eTS.textContent='Std '+fmtPct(ts);
  if(eTH)eTH.textContent='Hidden '+fmtPct(th);
  if(eTT)eTT.textContent='= '+fmtPct(ts+th);
  validateScenarioConfig(letter);

  // Analitiƒçka live procena - prikazuje aproksimaciju pre pokretanja simulacije
  var tStr = (document.getElementById('monthlyTurnoverEur') || {}).value || '0';
  var monthlyT = parseFloat(tStr.replace(/,/g,'')) || 0;
  if (monthlyT > 0) {
    var lsLevs = [
      {p:'pl', ls:'ls'+letter+'_pl'},
      {p:'gd', ls:'ls'+letter+'_gd'},
      {p:'dm', ls:'ls'+letter+'_dm'}
    ];
    var totalEstPaid = 0;
    lsLevs.forEach(function(lv) {
      var std  = (parseFloat(document.getElementById('scenario'+letter+'_'+lv.p+'_std').value)||0)/100;
      var base = parseFloat(document.getElementById('scenario'+letter+'_'+lv.p+'_base').value)||0;
      var mn   = parseFloat(document.getElementById('scenario'+letter+'_'+lv.p+'_min').value)||0;
      var mx   = parseFloat(document.getElementById('scenario'+letter+'_'+lv.p+'_max').value)||0;
      var elv  = document.getElementById(lv.ls);
      if (!elv) return;
      if (std <= 0 || mx <= base) { elv.textContent = '‚Äî'; return; }
      // Payout je uvek izmedju min i max - hidden ne menja iznos isplate
      var avgPayout  = (mn + mx) / 2;
      var cycleLen   = (avgPayout - base) / std;
      if (cycleLen <= 0) { elv.textContent = '‚Äî'; return; }
      var estDrops   = Math.round(monthlyT / cycleLen);
      totalEstPaid  += estDrops * avgPayout;
      elv.textContent = '~' + estDrops.toLocaleString() + '√ó @ ~' + Math.round(avgPayout) + ' EUR';
    });
    var rtpEst = (totalEstPaid / monthlyT * 100).toFixed(3) + '%';
    var rtpElEst = document.getElementById('ls'+letter+'_rtp');
    if (rtpElEst) rtpElEst.textContent = rtpEst;
  }
}

function validateScenarioConfig(letter) {
  var levels = [
    { name: 'Platinum', prefix: 'pl' },
    { name: 'Gold',     prefix: 'gd' },
    { name: 'Diamond',  prefix: 'dm' }
  ];
  var warnings = [];
  var hasErrors = false;

  levels.forEach(function(lv) {
    var stdPct    = (parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_std').value)    || 0) / 100;
    var hiddenPct = (parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_hidden').value) || 0) / 100;
    var base      = parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_base').value) || 0;
    var min       = parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_min').value)  || 0;
    var max       = parseFloat(document.getElementById('scenario' + letter + '_' + lv.prefix + '_max').value)  || 0;

    if (base > min) {
      warnings.push({ type: 'error',
        message: '<strong>' + lv.name + ':</strong> Base Value (' + base.toFixed(2) +
          ' EUR) ne mo≈æe biti VEƒÜI od Min Drop Zone (' + min.toFixed(2) + ' EUR)!'
      });
      hasErrors = true;
    }

    if (max > 0 && min >= max) {
      warnings.push({ type: 'error',
        message: '<strong>' + lv.name + ':</strong> Min Drop Zone (' + min.toFixed(2) +
          ' EUR) mora biti MANJI od Max Drop Zone (' + max.toFixed(2) + ' EUR)!'
      });
      hasErrors = true;
    }

    if (stdPct > 0 && hiddenPct > 0 && max > base) {
      var maxCycleTurnover  = (max - base) / stdPct;
      var hiddenAccumulated = maxCycleTurnover * hiddenPct;
      var nextJpStart       = base + hiddenAccumulated;

      if (nextJpStart > max) {
        var overflow    = nextJpStart - max;
        var overflowPct = (overflow / max) * 100;
        warnings.push({ type: 'error',
          message: '<strong>' + lv.name + ' ‚Äì HIDDEN OVERFLOW!</strong><br>' +
            'Ako JP padne na Max (' + max.toFixed(2) + ' EUR), hidden doprinos = ' +
            hiddenAccumulated.toFixed(2) + ' EUR.<br>' +
            'Sledeƒái JP bi poƒçeo sa <strong>' + nextJpStart.toFixed(2) +
            ' EUR</strong> ‚Üí <strong>' + overflow.toFixed(2) +
            ' EUR iznad Max-a</strong> (' + overflowPct.toFixed(1) + '%)!<br>' +
            '<em>RE≈†ENJE: Smanji Hidden % ili poveƒáaj Max vrednost.</em>'
        });
        hasErrors = true;
      } else if (nextJpStart > max * 0.95) {
        warnings.push({ type: 'warning',
          message: '<strong>' + lv.name + ' ‚Äì UPOZORENJE:</strong> Hidden doprinos (' +
            hiddenAccumulated.toFixed(2) + ' EUR) je blizu Max-a. Sledeƒái JP bi poƒçeo sa ' +
            nextJpStart.toFixed(2) + ' EUR (' +
            ((nextJpStart / max) * 100).toFixed(1) + '% od Max-a).'
        });
      }
    }
  });

  // Prika≈æi/sakrij warnings
  var warningsDiv = document.getElementById('scWarnings_' + letter);
  if (warningsDiv) {
    warningsDiv.innerHTML = '';
    warnings.forEach(function(w) {
      var div = document.createElement('div');
      div.className = w.type;
      div.innerHTML = (w.type === 'error' ? 'üö´ ' : '‚ö†Ô∏è ') + w.message;
      warningsDiv.appendChild(div);
    });
  }

  // Disable/enable Run dugme na osnovu gre≈°aka
  var runBtn = document.getElementById('runScenarioBtn_' + letter);
  if (runBtn) {
    runBtn.disabled = hasErrors;
    runBtn.title = hasErrors
      ? '‚õî Ispravite gre≈°ke pre pokretanja simulacije'
      : '';
    // Vizuelni feedback - tekst
    var scenName = (document.getElementById('scenario' + letter + '_name') || {}).value || ('Scenario ' + letter);
    runBtn.textContent = hasErrors
      ? '‚õî Gre≈°ka ‚Äì ne mo≈æe se pokrenuti'
      : '‚ñ∂ Run Scenario ' + letter;
  }
}

// Inicijalizacija pri uƒçitavanju stranice
(function initScenarioContribs() {
  function run() {
    ['A','B','C'].forEach(function(l) { updateAllScenarioContribs(l); });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    setTimeout(run, 0);
  }
})();


</script>

</body>
</html>
